<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>צפייה בערוצים</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
  <style>
    body { background-color: #111827; color: white; font-family: sans-serif; }
    .sticky-header {
      position: sticky;
      top: 0;
      z-index: 50;
      background-color: #1f2937;
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .channel-button.active { background-color: #2563eb; }
    .channel-button .status-icon { margin-right: 4px; }
  </style>
</head>
<body class="pb-20">

  <!-- תפריט עליון קבוע -->
  <div class="sticky-header p-3">
    <h1 class="text-center text-xl font-bold mb-2">בחר ערוצים</h1>
    <div id="channel-buttons" class="flex overflow-x-auto gap-2 px-2">
      <!-- כפתורים יתווספו כאן -->
    </div>
  </div>

  <!-- תצוגת הווידאו -->
  <div id="video-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
    <!-- סרטונים ייווצרו כאן -->
  </div>

  <p id="no-channel-message" class="text-center text-gray-400 mt-6">בחר ערוץ לצפייה</p>

  <script>
    const channels = {
      kan11: { name: "כאן 11", type: "hls", url: "https://kan11w.media.kan.org.il/hls/live/2105694/2105694/source1_4k/chunklist.m3u8" },
      now14: { name: "עכשיו 14", type: "youtube", videoId: "_qOB__gXgi0" },
      i24news: { name: "i24NEWS", type: "hls", url: "https://bcovlive-a.akamaihd.net/d89ede8094c741b7924120b27764153c/eu-central-1/5377161796001/profile_0/chunklist.m3u8" },
      news13: { name: "חדשות 13", type: "hls", url: "https://d198ztbnlup2iq.cloudfront.net/out/v1/2d9050c90fb94df8b78d1d98306a1a65/index.m3u8" },
      news12: {
        name: "חדשות 12", type: "iframe",
        url: "https://www.mako.co.il/AjaxPage?jspName=embedHTML5video.jsp&galleryChannelId=798cfb1e06667910VgnVCM200000650a10acRCRD&videoChannelId=7690b3a2a4ac5910VgnVCM200000650a10acRCRD&vcmid=003432e70df02310VgnVCM100000290b320aRCRD",
        muteParam: "muted"
      }
    };

    const activeChannels = [];
    let activeAudioKey = null;
    const grid = document.getElementById("video-grid");
    const message = document.getElementById("no-channel-message");
    const btnContainer = document.getElementById("channel-buttons");

    function buildUrl(base, muted, muteParam = "muted") {
      try {
        const url = new URL(base);
        url.searchParams.set(muteParam, muted ? "true" : "false");
        url.searchParams.set("autoplay", "true");
        return url.toString();
      } catch {
        return base;
      }
    }

    function render() {
      grid.innerHTML = "";
      message.classList.toggle("hidden", activeChannels.length > 0);

      activeChannels.forEach(key => {
        const ch = channels[key];
        const container = document.createElement("div");
        container.className = "relative aspect-video rounded overflow-hidden bg-black";

        let el;
        const hasAudio = key === activeAudioKey;

        if (ch.type === "hls") {
          el = document.createElement("video");
          el.className = "w-full h-full";
          el.autoplay = true;
          el.controls = true;
          el.muted = !hasAudio;
          if (Hls.isSupported()) {
            const hls = new Hls();
            hls.loadSource(ch.url);
            hls.attachMedia(el);
          } else {
            el.src = ch.url;
          }
        } else if (ch.type === "youtube") {
          const divId = "yt-" + key;
          el = document.createElement("div");
          el.id = divId;
          el.className = "w-full h-full";
          setTimeout(() => {
            new YT.Player(divId, {
              videoId: ch.videoId,
              playerVars: { autoplay: 1, mute: !hasAudio ? 1 : 0, rel: 0 },
              events: {
                onReady: e => { if (!hasAudio) e.target.mute(); else e.target.unMute(); e.target.playVideo(); }
              }
            });
          }, 0);
        } else {
          el = document.createElement("iframe");
          el.className = "w-full h-full";
          el.allow = "autoplay; fullscreen";
          el.allowFullscreen = true;
          el.src = buildUrl(ch.url, !hasAudio, ch.muteParam);
        }

        container.appendChild(el);
        grid.appendChild(container);
      });

      updateButtons();
    }

    function updateButtons() {
      document.querySelectorAll(".channel-button").forEach(btn => {
        const key = btn.dataset.key;
        btn.classList.toggle("active", activeChannels.includes(key));
        const icon = btn.querySelector(".status-icon");
        if (activeChannels.includes(key)) {
          icon.textContent = (key === activeAudioKey) ? "🔊" : "✅";
        } else {
          icon.textContent = "";
        }
      });
    }

    function initButtons() {
      Object.entries(channels).forEach(([key, ch]) => {
        const btn = document.createElement("button");
        btn.className = "channel-button flex-shrink-0 px-4 py-2 rounded bg-gray-600 text-white whitespace-nowrap";
        btn.dataset.key = key;

        const icon = document.createElement("span");
        icon.className = "status-icon";
        btn.append(icon);
        btn.append(ch.name);

        btn.onclick = () => {
          const idx = activeChannels.indexOf(key);
          if (idx >= 0) {
            activeChannels.splice(idx, 1);
            if (activeAudioKey === key) activeAudioKey = null;
          } else {
            activeChannels.unshift(key);
          }
          render();
        };

        btnContainer.appendChild(btn);
      });
    }

    initButtons();
    render();
  </script>

</body>
</html>
