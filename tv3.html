<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>צפייה בערוצים</title>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-J5WT91REYB"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-J5WT91REYB');
  </script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #1F2937; color: white; font-family: sans-serif; margin: 0; }
    .video-container {
      position: relative;
      aspect-ratio: 16/9;
      border-radius: 8px;
      overflow: hidden;
    }
    .controls-container {
      position: absolute;
      top: 50%;
      left: 12px;
      transform: translateY(-50%);
      display: flex;
      flex-direction: column;
      gap: 10px;
      align-items: flex-start;
      z-index: 10;
      opacity: 0; /* Hidden by default */
      transition: opacity 0.3s ease-in-out; /* Smooth transition */
    }
    /* Controls become visible on hover for desktop */
    .video-container:hover .controls-container {
      opacity: 1;
    }
    /* Controls become visible on touch for mobile */
    .video-container.touch-active .controls-container {
      opacity: 1;
    }
    /* In fullscreen mode, controls should always be visible on interaction and fade out when not active */
    .fullscreen-mode .video-container.active-fullscreen .controls-container {
        opacity: 1; /* Always visible when active-fullscreen */
    }

    .sound-toggle, .fullscreen-toggle {
      display: flex;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,0.6);
      padding: 8px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.9rem;
      min-width: 90px;
      text-align: center;
      transition: 0.2s ease;
      color: white;
    }
    .sound-toggle.on { background: #10B981; }
    .sound-toggle.off { background: #EF4444; }
    .fullscreen-toggle { background: #4B5563; }
    .fullscreen-toggle.active { background: #4F46E5; }
    .channel-button { padding: 10px 20px; border-radius: 8px; background: #4B5563; transition: 0.2s; font-weight: bold; }
    .channel-button:hover { background: #6B7280; }
    .channel-button.active { background: #1F6FEB; transform: translateY(-2px); }

    /* General grid for all active channel counts, making videos equal size and symmetrical */
    #video-grid {
      display: grid;
      /* Adjust minmax value based on desired minimum video size and responsiveness */
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 1rem;
    }

    .fullscreen-mode .video-container:not(.active-fullscreen) {
      display: none !important;
    }
    .fullscreen-mode .video-container.active-fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 9999;
      background: #000;
      border-radius: 0;
    }
  </style>
</head>
<body class="p-4">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P5QLH7TD" height="0" width="0" style="display:none"></iframe></noscript>

<h1 class="text-2xl font-bold text-center mb-4">צפייה בערוצים</h1>
<div class="flex justify-center gap-3 flex-wrap mb-6">
  <button class="channel-button" data-channel="kan11">כאן 11</button>
  <button class="channel-button" data-channel="now14">עכשיו 14</button>
  <button class="channel-button" data-channel="i24news">i24NEWS</button>
  <button class="channel-button" data-channel="news13">חדשות 13</button>
  <button class="channel-button" data-channel="news12">חדשות 12</button>
</div>

<div id="video-grid" class="gap-4"></div>
<p id="no-channel-message" class="text-center text-gray-300 mt-6 hidden">יש לבחור ערוץ מהכפתורים מעלה</p>

<script>
const channels = {
  kan11: { type: 'hls', url: 'https://kan11w.media.kan.org.il/hls/live/2105694/2105694/source1_4k/chunklist.m3u8' },
  now14: {
    type: 'iframe',
    url: 'https://snippet.univtec.com/player.html?data-insight=eyJndWlkIjoiYjY3NmI5MDYtNTYyNS00OGFmLWEzMzEtMTFhNWQyMmUxNTFiIiwidHlwZSI6ImNoYW5uZWxzIiwiYWNjb3VudElkIjoiNjM5Nzc1M2ZmZjg3MTk3YWU2YTNjMDMiLCJjbGllbnQiOiJjaGFubmVsMTQiLCJhcGkiOiJodHRwczovL2luc2lnaHQtYXBpLWNoYW5uZWwxNC51bml2dGVjLmcom/MifQ==',
    muteParam: 'muted'
  },
  i24news: { type: 'hls', url: 'https://bcovlive-a.akamaihd.net/d89ede8094c741b7924120b27764153c/eu-central-1/5377161796001/profile_0/chunklist.m3u8' },
  news13: { type: 'hls', url: 'https://d198ztbnlup2iq.cloudfront.net/out/v1/2d9050c90fb94df8b78d1d98306a1a65/index.m3u8' },
  news12: {
    type: 'iframe',
    url: 'https://www.mako.co.il/AjaxPage?jspName=embedHTML5video.jsp&galleryChannelId=798cfb1e06667910VgnVCM200000650a10acRCRD&videoChannelId=7690b3a2a4ac5910VgnVCM200000650a10acRCRD&vcmid=003432e70df02310VgnVCM100000290b320aRCRD',
    muteParam: 'muted'
  }
};

let active = [];
let activeAudioKey = null;
let fullscreenKey = null;
const grid = document.getElementById('video-grid');
const message = document.getElementById('no-channel-message');

function buildUrl(base, muted, muteParam = 'muted') {
  const url = new URL(base);
  url.searchParams.set(muteParam, muted ? '1' : '0');
  url.searchParams.set('autoplay', '1');
  return url.toString();
}

function toggleFullscreen(key) {
  if (fullscreenKey === key) {
    fullscreenKey = null;
    document.body.classList.remove('fullscreen-mode');
    document.exitFullscreen?.();
  } else {
    fullscreenKey = key;
    activeAudioKey = key; // Mute others when one is fullscreen
    document.body.classList.add('fullscreen-mode');
    document.documentElement.requestFullscreen?.().catch(err => {
      console.log('Fullscreen error:', err);
    });
  }
  render();
}

function render() {
  grid.innerHTML = '';
  // The 'five-grid' class and its specific CSS are removed to rely on the general flexible grid
  message.classList.toggle('hidden', active.length > 0);

  active.forEach(key => {
    const ch = channels[key];
    const box = document.createElement('div');
    box.className = `video-container ${fullscreenKey === key ? 'active-fullscreen' : ''}`;

    let el;
    const hasAudio = key === activeAudioKey;
    if (ch.type === 'hls') {
      el = document.createElement('video');
      el.className = 'w-full h-full';
      el.autoplay = true;
      el.controls = true;
      el.muted = !hasAudio;
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(ch.url);
        hls.attachMedia(el);
      } else {
        el.src = ch.url;
      }
    } else {
      const muteParam = ch.muteParam || 'muted';
      el = document.createElement('iframe');
      el.src = buildUrl(ch.url, !hasAudio, muteParam);
      el.className = 'w-full h-full';
      el.allow = 'autoplay; fullscreen';
      el.setAttribute('frameborder', '0'); // Added for iframes to prevent default border
    }

    const controlsContainer = document.createElement('div');
    controlsContainer.className = 'controls-container';

    const soundBtn = document.createElement('button');
    soundBtn.className = `sound-toggle ${hasAudio ? 'on' : 'off'}`;
    soundBtn.textContent = hasAudio ? '🔊 השתק' : '🔇 שמע';
    soundBtn.onclick = e => {
      e.stopPropagation();
      activeAudioKey = hasAudio ? null : key;
      render();
    };

    const fullscreenBtn = document.createElement('button');
    fullscreenBtn.className = `fullscreen-toggle ${fullscreenKey === key ? 'active' : ''}`;
    fullscreenBtn.textContent = fullscreenKey === key ? '↩️ חזרה' : '⛶ מסך מלא';
    fullscreenBtn.onclick = e => {
      e.stopPropagation();
      toggleFullscreen(key);
    };

    controlsContainer.append(soundBtn, fullscreenBtn);
    box.append(el, controlsContainer);
    grid.appendChild(box);

    // Logic for fading in/out controls
    let controlsFadeTimeout; // Specific timeout for this video box

    box.addEventListener('mouseenter', () => {
      clearTimeout(controlsFadeTimeout); // Clear any pending fade-out
      controlsContainer.style.opacity = '1'; // Show controls
    });

    box.addEventListener('mouseleave', () => {
      // Set a timeout to hide controls after 1 second
      controlsFadeTimeout = setTimeout(() => {
        // Only hide if not in fullscreen mode for this specific video
        if (fullscreenKey !== key) {
          controlsContainer.style.opacity = '0';
        }
      }, 1000); // 1 second delay
    });

    // Touch events for mobile devices
    box.addEventListener('touchstart', () => {
      clearTimeout(controlsFadeTimeout); // Clear any pending fade-out
      controlsContainer.style.opacity = '1'; // Show controls
      box.classList.add('touch-active'); // Add class to indicate touch activity
    });

    box.addEventListener('touchend', () => {
      // Set a timeout to hide controls after 1 second
      controlsFadeTimeout = setTimeout(() => {
        // Only hide if not in fullscreen mode for this specific video
        if (fullscreenKey !== key) {
          controlsContainer.style.opacity = '0';
        }
        box.classList.remove('touch-active'); // Remove touch active class
      }, 1000); // 1 second delay
    });
  });
}

document.addEventListener('fullscreenchange', () => {
  // If fullscreen is exited by user (e.g., Esc key), reset fullscreenKey
  if (!document.fullscreenElement && fullscreenKey) {
    toggleFullscreen(null);
  }
});

// Keyboard navigation for fullscreen videos
document.addEventListener('keydown', (e) => {
  if (!fullscreenKey) return; // Only apply if a video is in fullscreen
  const idx = active.indexOf(fullscreenKey);
  if (e.key === 'ArrowRight' && idx < active.length - 1) {
    fullscreenKey = active[idx + 1];
    activeAudioKey = fullscreenKey; // Ensure audio follows fullscreen video
    render();
  }
  if (e.key === 'ArrowLeft' && idx > 0) {
    fullscreenKey = active[idx - 1];
    activeAudioKey = fullscreenKey; // Ensure audio follows fullscreen video
    render();
  }
});

// Touch swipe navigation for fullscreen videos
let touchStartX = 0;
document.addEventListener('touchstart', e => {
  if (e.touches.length === 1) touchStartX = e.touches[0].clientX;
});
document.addEventListener('touchend', e => {
  if (!fullscreenKey || e.changedTouches.length !== 1) return;
  const diffX = e.changedTouches[0].clientX - touchStartX;
  const idx = active.indexOf(fullscreenKey);
  if (diffX < -50 && idx < active.length - 1) { // Swipe left
    fullscreenKey = active[idx + 1];
    activeAudioKey = fullscreenKey;
    render();
  }
  if (diffX > 50 && idx > 0) { // Swipe right
    fullscreenKey = active[idx - 1];
    activeAudioKey = fullscreenKey;
    render();
  }
});

// Mouse drag navigation for fullscreen videos
let mouseDownX = null;
document.addEventListener('mousedown', e => {
  if (fullscreenKey) mouseDownX = e.clientX;
});
document.addEventListener('mouseup', e => {
  if (!fullscreenKey || mouseDownX === null) return;
  const diffX = e.clientX - mouseDownX;
  const idx = active.indexOf(fullscreenKey);
  if (diffX < -100 && idx < active.length - 1) { // Drag left
    fullscreenKey = active[idx + 1];
    activeAudioKey = fullscreenKey;
    render();
  }
  if (diffX > 100 && idx > 0) { // Drag right
    fullscreenKey = active[idx - 1];
    activeAudioKey = fullscreenKey;
    render();
  }
  mouseDownX = null; // Reset for next drag
});

// Event listeners for channel buttons
document.querySelectorAll('.channel-button').forEach(btn => {
  const key = btn.dataset.channel;
  btn.onclick = () => {
    if (active.includes(key)) {
      active = active.filter(k => k !== key);
      if (activeAudioKey === key) activeAudioKey = null; // Mute if removed
      if (fullscreenKey === key) toggleFullscreen(null); // Exit fullscreen if removed
      btn.classList.remove('active');
    } else {
      active.unshift(key); // Add to beginning for newer channels to appear first
      btn.classList.add('active');
    }
    render(); // Re-render the grid
  };
});

render(); // Initial render on page load
</script>

<footer class="mt-10 text-center text-sm text-gray-400">
  <!-- Original footer content preserved -->
  <button id="fullscreen-toggle" class="footer-link-button mt-2">צפייה במסך גדול</button>

  <div class="mb-2">גם תחנות רדיו להאזנה:</div>
  <a href="https://mistralnet.github.io/radio" class="inline-block bg-indigo-600 hover:bg-indigo-500 text-white py-2 px-4 rounded mb-4">🎧 תחנות רדיו</a>
  <div class="flex justify-center gap-4 flex-wrap mb-4">
    <a href="https://mistralnet.github.io/radio/" class="text-blue-400 hover:text-blue-300">Radio</a>
    <a href="https://mistralnet.github.io/radio/tv.html" class="text-blue-400 hover:text-blue-300">TV</a>
    <a href="https://mistralnet.github.io/radio/tv2.html" class="text-blue-400 hover:text-blue-300">TV2</a>
    <a href="https://mistralnet.github.io/radio/tv3.html" class="text-blue-400 hover:text-blue-300">TV3</a>
    <a href="https://mistralnet.github.io/radio/tv4.html" class="text-blue-400 hover:text-blue-300">TV4</a>
  </div>
  <div class="version-info">גרסה 6.44 - עם ניווט בין ערוצים במסך מלא ועיצוב כפתורים שמאלי</div>
</footer>
</body>
</html>
