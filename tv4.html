<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>צפייה בערוצים</title>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-J5WT91REYB"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-J5WT91REYB');
  </script>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: #1F2937; color: white; font-family: sans-serif; margin: 0; }
    .video-container { position: relative; aspect-ratio: 16/9; border-radius: 8px; overflow: hidden; }
    .sound-toggle, .fullscreen-toggle {
      position: absolute; left: 10px;
      background: rgba(0,0,0,0.6); padding: 6px 10px;
      border-radius: 6px; cursor: pointer;
      font-size: 0.85rem; display: none;
    }
    .sound-toggle { top: 50%; transform: translateY(-50%); }
    .fullscreen-toggle { bottom: 10px; }
    .video-container:hover .sound-toggle,
    .video-container:hover .fullscreen-toggle { display: inline-block; }
    .sound-toggle.on { background: #10B981; }
    .sound-toggle.off { background: #EF4444; }
    .fullscreen-toggle.active { background: #4F46E5; }
    .channel-button { padding: 10px 20px; border-radius: 8px; background: #4B5563; transition: 0.2s; font-weight: bold; }
    .channel-button:hover { background: #6B7280; }
    .channel-button.active { background: #1F6FEB; transform: translateY(-2px); }
    @media (min-width: 768px) {
      #video-grid.five-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-auto-rows: auto;
      }
      #video-grid.five-grid .video-container:nth-child(n+4) {
        grid-column: span 3;
        display: flex;
        justify-content: center;
        gap: 1rem;
      }
      #video-grid.five-grid .video-container:nth-child(4),
      #video-grid.five-grid .video-container:nth-child(5) {
        width: calc(50% - 0.5rem);
      }
    }
    .fullscreen-mode .video-container:not(.active-fullscreen) {
      display: none !important;
    }
    .fullscreen-mode .video-container.active-fullscreen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 9999;
      background: #000;
      border-radius: 0;
    }
  </style>
</head>
<body class="p-4">
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P5QLH7TD" height="0" width="0" style="display:none"></iframe></noscript>

<h1 class="text-2xl font-bold text-center mb-4">צפייה בערוצים</h1>
<div class="flex justify-center gap-3 flex-wrap mb-6">
  <button class="channel-button" data-channel="kan11">כאן 11</button>
  <button class="channel-button" data-channel="now14">עכשיו 14</button>
  <button class="channel-button" data-channel="i24news">i24NEWS</button>
  <button class="channel-button" data-channel="news13">חדשות 13</button>
  <button class="channel-button" data-channel="news12">חדשות 12</button>
</div>

<div id="video-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
<p id="no-channel-message" class="text-center text-gray-300 mt-6 hidden">יש לבחור ערוץ מהכפתורים מעלה</p>

<script>
const channels = {
  kan11: { type: 'hls', url: 'https://kan11w.media.kan.org.il/hls/live/2105694/2105694/source1_4k/chunklist.m3u8' },
  now14: { type: 'iframe', url: 'https://snippet.univtec.com/player.html?data-insight=eyJndWlkIjoiYjY3NmI5MDYtNTYyNS00OGFmLWEzMzEtMTFhNWQyMmUxNTFiIiwidHlwZSI6ImNoYW5uZWxzIiwiYWNjb3VudElkIjoiNjM5Nzc1M2ZmZjg3MTk3YWU2YTNjMDMiLCJjbGllbnQiOiJjaGFubmVsMTQiLCJhcGkiOiJodHRwczovL2luc2lnaHQtYXBpLWNoYW5uZWwxNC51bml2dGVjLmNvbS8ifQ==' },
  i24news: { type: 'hls', url: 'https://bcovlive-a.akamaihd.net/d89ede8094c741b7924120b27764153c/eu-central-1/5377161796001/profile_0/chunklist.m3u8' },
  news13: { type: 'hls', url: 'https://d198ztbnlup2iq.cloudfront.net/out/v1/2d9050c90fb94df8b78d1d98306a1a65/index.m3u8' },
  news12: { type: 'iframe', url: 'https://www.mako.co.il/AjaxPage?jspName=embedHTML5video.jsp&galleryChannelId=798cfb1e06667910VgnVCM200000650a10acRCRD&videoChannelId=7690b3a2a4ac5910VgnVCM200000650a10acRCRD&vcmid=003432e70df02310VgnVCM100000290b320aRCRD' }
};

let active = [];
let activeAudioKey = null;
let fullscreenKey = null;
const grid = document.getElementById('video-grid');
const message = document.getElementById('no-channel-message');

function buildUrl(base, muted) {
  const sep = base.includes('?') ? '&' : '?';
  return `${base}${sep}autoplay=1&muted=${muted ? 1 : 0}`;
}

function toggleFullscreen(key) {
  if (fullscreenKey === key) {
    // יציאה ממצב מסך מלא
    fullscreenKey = null;
    document.body.classList.remove('fullscreen-mode');
    document.exitFullscreen?.();
  } else {
    // כניסה למצב מסך מלא
    fullscreenKey = key;
    activeAudioKey = key; // הפעלת סאונד רק בערוץ הנוכחי
    
    // הוספת מחלקה לגוף כדי לשלוט בתצוגה
    document.body.classList.add('fullscreen-mode');
    
    // ניסיון להפעלת מסך מלא בדפדפן
    document.documentElement.requestFullscreen?.().catch(err => {
      console.log('Fullscreen error:', err);
    });
  }
  render();
}

function render() {
  grid.innerHTML = '';
  grid.className = active.length === 5 ? 'five-grid gap-4' : 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
  message.classList.toggle('hidden', active.length > 0);

  active.forEach(key => {
    const ch = channels[key];
    const box = document.createElement('div');
    box.className = `video-container ${fullscreenKey === key ? 'active-fullscreen' : ''}`;
    
    let el;
    const hasAudio = key === activeAudioKey;
    if (ch.type === 'hls') {
      el = document.createElement('video');
      el.className = 'w-full h-full';
      el.autoplay = true; el.controls = true; el.muted = !hasAudio;
      if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource(ch.url);
        hls.attachMedia(el);
      } else {
        el.src = ch.url;
      }
    } else {
      el = document.createElement('iframe');
      el.src = buildUrl(ch.url, !hasAudio);
      el.className = 'w-full h-full';
      el.allow = 'autoplay; fullscreen';
      el.id = `iframe-${key}`;
    }

    const soundBtn = document.createElement('button');
    soundBtn.className = `sound-toggle ${hasAudio ? 'on' : 'off'}`;
    soundBtn.textContent = hasAudio ? '🔊 השתק' : '🔇 שמע';
    soundBtn.onclick = e => {
      e.stopPropagation();
      activeAudioKey = hasAudio ? null : key;
      
      // אם זה ערוץ 14, נשלח הודעה ל-iframe כדי לעדכן את הסאונד
      if (key === 'now14') {
        const iframe = document.getElementById(`iframe-${key}`);
        if (iframe && iframe.contentWindow) {
          iframe.contentWindow.postMessage({
            type: 'setMuted',
            muted: !hasAudio
          }, '*');
        }
      }
      
      render();
    };

    const fullscreenBtn = document.createElement('button');
    fullscreenBtn.className = `fullscreen-toggle ${fullscreenKey === key ? 'active' : ''}`;
    fullscreenBtn.textContent = fullscreenKey === key ? '↩️ חזרה' : '⛶ מסך מלא';
    fullscreenBtn.onclick = e => {
      e.stopPropagation();
      toggleFullscreen(key);
    };

    box.append(el, soundBtn, fullscreenBtn);
    grid.appendChild(box);
  });
}

// מאזין להודעות מה-iframe של ערוץ 14
window.addEventListener('message', function(event) {
  console.log('Message from iframe:', event.data);
});

// מאזין לשינויי מצב מסך מלא
document.addEventListener('fullscreenchange', () => {
  if (!document.fullscreenElement && fullscreenKey) {
    toggleFullscreen(null); // יציאה ממצב מסך מלא אם המשתמש יצא ידנית
  }
});

document.querySelectorAll('.channel-button').forEach(btn => {
  const key = btn.dataset.channel;
  btn.onclick = () => {
    if (active.includes(key)) {
      active = active.filter(k => k !== key);
      if (activeAudioKey === key) activeAudioKey = null;
      if (fullscreenKey === key) {
        toggleFullscreen(null); // יציאה ממצב מסך מלא אם סוגרים את הערוץ
      }
      btn.classList.remove('active');
    } else {
      active.unshift(key);
      btn.classList.add('active');
    }
    render();
  };
});

render();
</script>

<footer class="mt-10 text-center text-sm text-gray-400">
  <div class="mb-2">גם תחנות רדיו להאזנה:</div>
  <a href="https://mistralnet.github.io/radio" class="inline-block bg-indigo-600 hover:bg-indigo-500 text-white py-2 px-4 rounded mb-4">🎧 תחנות רדיו</a>
  <div class="flex justify-center gap-4 flex-wrap mb-4">
    <a href="https://mistralnet.github.io/radio/" class="text-blue-400 hover:text-blue-300">Radio</a>
    <a href="https://mistralnet.github.io/radio/tv.html" class="text-blue-400 hover:text-blue-300">TV</a>
    <a href="https://mistralnet.github.io/radio/tv2.html" class="text-blue-400 hover:text-blue-300">TV2</a>
    <a href="https://mistralnet.github.io/radio/tv3.html" class="text-blue-400 hover:text-blue-300">TV3</a>
    <a href="https://mistralnet.github.io/radio/tv4.html" class="text-blue-400 hover:text-blue-300">TV4</a>
  </div>
  <div class="version-info">גרסה 5.9 TV4 - עם ניהול סאונד אוטומטי במסך מלא</div>
</footer>
</body>
</html>
