<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>爪驻 注专1爪</title>

    <!-- Google Analytics Script -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J5WT91REYB"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-J5WT91REYB');
    </script>

    <!-- HLS.js Library for HLS streams -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- Feather Icons for clear UI icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <style>
        /* CSS Variables for consistent theming */
        :root {
            --bg-color: #0a0a0a;
            --header-bg-color: #1a1a1a;
            --nav-bg-color: #1f2937; /* bg-gray-800 */
            --nav-btn-bg-color: #3b82f6; /* A clear blue, bg-blue-500 */
            --nav-btn-active-bg-color: #10b981; /* A bright green, bg-emerald-500 */
            --text-color: #f9fafb; /* text-gray-50 */
            --text-color-inactive: #e5e7eb; /* text-gray-200 for better readability on blue */
            --active-grid-border: #6ee7b7; /* emerald-200 for active border */
        }

        /* --- General Body and Typography --- */
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Heebo', sans-serif;
            margin: 0;
            padding-bottom: 90px; /* Reserve space for bottom nav bar */
            overflow-x: hidden; /* Prevent horizontal scroll on animations */
        }

        /* --- Main Content and Video Grid --- */
        .main-content {
            padding: 1.5rem 1rem;
        }

        .video-container {
            position: relative;
            aspect-ratio: 16/9;
            border-radius: 12px;
            overflow: hidden;
            background-color: #000;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            transition: transform 0.2s ease-in-out, border-color 0.3s ease, box-shadow 0.3s ease;
            border: 2px solid transparent; /* Default transparent border */
        }

        .video-container.active-audio-highlight {
            border-color: var(--active-grid-border); /* Highlight active audio channel */
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.7); /* Stronger shadow for active */
        }

        .video-container video, .video-container iframe {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block; /* Remove extra space below video */
        }

        /* --- Loading Indicator --- */
        .loading-indicator {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.2rem;
            z-index: 20;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .loading-indicator.hidden {
            opacity: 0;
            pointer-events: none; /* Allow clicks through when hidden */
        }

        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- Per-Video Controls (Grid View) --- */
        .grid-controls-overlay {
            position: absolute;
            inset: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            z-index: 10;
            opacity: 0;
            transition: opacity 0.3s ease;
            background: rgba(0,0,0,0.2);
            backdrop-filter: blur(2px);
        }

        .video-container:hover .grid-controls-overlay {
            opacity: 1;
        }

        .channel-name-bar {
            width: 100%;
            text-align: right;
            background: linear-gradient(to bottom, rgba(0,0,0,0.6), transparent);
            color: white;
            padding: 8px 12px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .grid-control-buttons {
            display: flex;
            gap: 1rem;
            padding-bottom: 1rem;
        }

        .control-btn {
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            width: 44px;
            height: 44px;
        }

        .control-btn:hover {
            transform: scale(1.1);
            background: rgba(55, 65, 81, 0.9);
        }

        /* --- Redesigned Bottom Navigation Bar (Grid View) --- */
        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background-color: var(--nav-bg-color);
            box-shadow: 0 -4px 15px rgba(0,0,0,0.4);
            border-top: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: center; /* Center the buttons */
            align-items: center;
            padding: 12px 0;
            gap: 10px; /* Space between buttons */
            height: 75px;
        }

        .channel-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-color-inactive); /* Use inactive text color */
            background-color: var(--nav-btn-bg-color); /* Use inactive button color */
            border-radius: 12px; /* Rounded corners */
            width: 60px;
            height: 55px;
            transition: all 0.2s ease-in-out;
            font-size: 1.1rem; /* Larger font size */
            font-weight: 700;
            position: relative;
            border: 2px solid transparent;
        }

        .channel-button:hover {
            transform: translateY(-3px);
            color: var(--text-color); /* Use active text color on hover */
        }

        .channel-button.active {
            color: var(--text-color); /* Use active text color */
            background-color: var(--nav-btn-active-bg-color); /* Use active button color */
            border-color: #6ee7b7; /* emerald-200 for active border */
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.7); /* Adjusted shadow to match active color */
        }

        /* Updated audio indicator styling for better visibility */
        .audio-indicator {
            position: absolute;
            top: 0px; /* Adjusted to be slightly higher */
            left: 5px; /* Moved to the left for better visibility */
            font-size: 1rem; /* Increased font size for prominence */
            color: #fde047; /* yellow-300 */
            text-shadow: 0 0 5px rgba(0, 0, 0, 0.7); /* Added subtle shadow for contrast */
        }

        /* --- Fullscreen Mode --- */
        /* Ensure HTML and Body fill the entire screen when in fullscreen mode */
        html:-webkit-full-screen, html:-moz-full-screen, html:-ms-fullscreen, html:fullscreen {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        body.fullscreen-mode {
            width: 100%;
            height: 100%;
            overflow: hidden; /* Prevent scrolling */
            margin: 0; /* Ensure no body margin */
            padding: 0; /* Ensure no body padding */
        }

        body.fullscreen-mode .main-content {
            display: none; /* Hide grid view */
        }
        body.fullscreen-mode #bottom-nav {
            display: none; /* Hide grid bottom nav */
        }

        #fullscreen-container {
            z-index: 9999;
            background: #000;
            display: none; /* Hidden by default */
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: fixed; /* Use fixed to cover entire viewport */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        body.fullscreen-mode #fullscreen-container {
            display: flex; /* Show container when in fullscreen mode */
        }

        #fullscreen-container .video-container {
            width: 100%;
            height: 100%;
            border-radius: 0;
            /* Removed absolute positioning and opacity/transform for simpler zapping */
            /* The single active fullscreen video will fill this container */
        }

        /* --- Fullscreen Controls --- */
        #fullscreen-controls {
            position: absolute;
            inset: 0;
            z-index: 10001;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding: 2rem;
            background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent 25%, transparent 75%, rgba(0,0,0,0.5));
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none; /* Initially non-interactive */
        }

        #fullscreen-container:hover #fullscreen-controls,
        #fullscreen-container.touch-active #fullscreen-controls,
        #fullscreen-controls.visible { /* New class for persistent visibility */
            opacity: 1;
            pointer-events: auto; /* Make interactive when visible */
        }

        .fullscreen-top-controls {
            width: 100%;
            display: flex;
            justify-content: flex-end; /* Push channel name to right in RTL, exit button will be on left */
            align-items: center;
        }

        .fullscreen-bottom-controls {
            width: 100%;
            display: flex;
            justify-content: space-between; /* Distribute items with space between them */
            align-items: center;
            padding: 0 1rem; /* Add some horizontal padding */
        }

        .fullscreen-center-buttons {
            display: flex;
            gap: 2rem; /* Space between mute and exit buttons */
        }

        .fullscreen-channel-name {
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 2px 2px 5px #000;
            margin-right: auto; /* Pushes channel name to the right in RTL */
        }

        .fs-btn {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 50%;
            cursor: pointer;
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            pointer-events: auto; /* Ensure buttons are clickable */
        }

        .fs-btn:hover {
            transform: scale(1.1);
            background: rgba(55, 65, 81, 0.9);
        }

        /* Feather icons size inside buttons */
        .fs-btn i {
            width: 32px;
            height: 32px;
        }

        /* --- Footer --- */
        footer {
            padding: 1.5rem 1rem;
        }

    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P5QLH7TD" height="0" width="0" style="display:none"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->

    <main class="main-content">
        <h1 class="text-3xl font-bold text-center mb-2">爪驻 注专爪</h1>
        <p class="text-center text-gray-400 mb-6">爪 注 住驻专 注专抓  住祝 转 转爪</p>
        <div id="video-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
            <!-- Video players will be inserted here -->
        </div>
        <p id="no-channel-message" class="text-center text-gray-400 mt-10 text-lg">砖 专 注专抓 转驻专 转转</p>
    </main>

    <!-- New Footer Section for additional links and information -->
    <footer class="mt-10 text-center text-sm text-gray-400">
        <div class="mb-2"> 转转 专 :</div>
        <a href="https://mistralnet.github.io/radio" class="inline-block bg-indigo-600 hover:bg-indigo-500 text-white py-2 px-4 rounded mb-4"> 转转 专</a>
        <div class="flex justify-center gap-4 flex-wrap mb-4">
            <a href="https://mistralnet.github.io/radio/" class="text-blue-400 hover:text-blue-300">Radio</a>
            <a href="https://mistralnet.github.io/radio/tv.html" class="text-blue-400 hover:text-blue-300">TV</a>
            <a href="https://mistralnet.github.io/radio/tv2.html" class="text-blue-400 hover:text-blue-300">TV2</a>
            <a href="https://mistralnet.github.io/radio/tv3.html" class="text-blue-400 hover:text-blue-300">TV3</a>
            <a href="https://mistralnet.github.io/radio/tv4.html" class="text-blue-400 hover:text-blue-300">TV4</a>
        </div>
        <div class="version-info">
            专住 砖驻专转
        </div>
    </footer>

    <!-- Container for the fullscreen player - only one active at a time -->
    <div id="fullscreen-container">
        <!-- Fullscreen controls will be dynamically added/removed here -->
    </div>

    <!-- Redesigned Bottom Navigation Bar -->
    <nav id="bottom-nav">
        <!-- Channel buttons will be dynamically inserted here -->
    </nav>

    <script>
        // --- Configuration and State ---
        const channels = {
            kan11: { name: ' 11', short: '11', type: 'hls', url: 'https://kan11w.media.kan.org.il/hls/live/2105694/2105694/source1_4k/chunklist.m3u8' },
            news12: { name: '砖转 12', short: '12', type: 'iframe', url: 'https://www.mako.co.il/AjaxPage?jspName=embedHTML5video.jsp&galleryChannelId=798cfb1e06667910VgnVCM200000650a10acRCRD&videoChannelId=7690b3a2a4ac5910VgnVCM100000650a10acRCRD&vcmid=003432e70df02310VgnVCM100000290b320aRCRD', muteParam: 'muted' },
            news13: { name: '砖转 13', short: '13', type: 'hls', url: 'https://d198ztbnlup2iq.cloudfront.net/out/v1/2d9050c90fb94df8b78d1d98306a1a65/index.m3u8' },
            now14: { name: '注砖 14', short: '14', type: 'hls', url: 'https://now14.g-mana.live/media/91517651-71c1-4775-a85f-dedf4df89f92/main.m3u8' },
            i24news: { name: 'i24NEWS', short: 'i24', type: 'hls', url: 'https://bcovlive-a.akamaihd.net/d89ede8094c741b7924120b27764153c/eu-central-1/5377161796001/profile_0/chunklist.m3u8' }
        };

        // Load state from localStorage
        const savedState = JSON.parse(localStorage.getItem('tvAppState')) || {};
        let activeChannels = savedState.activeChannels || []; // Array of channel keys currently displayed in the grid
        let activeAudioKey = savedState.activeAudioKey || null; // Key of the channel that currently has audio
        let fullscreenKey = savedState.fullscreenKey || null; // Key of the channel currently in fullscreen mode
        let lastAudioPreference = savedState.lastAudioPreference !== undefined ? savedState.lastAudioPreference : false;

        // Object to store Hls.js instances for proper cleanup
        let hlsInstances = {};
        // Object to store references to player elements (video/iframe) currently in the DOM
        let playerElements = {};

        // DOM elements
        const grid = document.getElementById('video-grid');
        const message = document.getElementById('no-channel-message');
        const bottomNavContainer = document.getElementById('bottom-nav');
        const fullscreenContainer = document.getElementById('fullscreen-container');

        // --- Inactivity Timer Variables and Functions ---
        let userActivityTimeout;
        let controlsVisibilityTimeout;
        const CONTROLS_HIDE_TIMEOUT_MS = 5000;

        /**
         * Saves the current state to localStorage
         */
        function saveState() {
            const state = {
                activeChannels,
                activeAudioKey,
                fullscreenKey,
                lastAudioPreference
            };
            localStorage.setItem('tvAppState', JSON.stringify(state));
        }

        /**
         * Shows fullscreen controls and sets a timeout to hide them.
         */
        function showFullscreenControls() {
            const controls = document.getElementById('fullscreen-controls');
            if (controls) {
                controls.classList.add('visible');
                clearTimeout(controlsVisibilityTimeout);
                controlsVisibilityTimeout = setTimeout(() => {
                    controls.classList.remove('visible');
                }, CONTROLS_HIDE_TIMEOUT_MS);
            }
        }

        // Attach global activity listeners
        document.addEventListener('mousemove', showFullscreenControls);
        document.addEventListener('keydown', showFullscreenControls);
        document.addEventListener('click', showFullscreenControls);
        document.addEventListener('touchstart', (e) => {
            if (fullscreenKey) {
                fullscreenContainer.classList.add('touch-active');
            }
            showFullscreenControls();
        }, { passive: true });
        document.addEventListener('touchend', (e) => {
            if (fullscreenKey) {
                setTimeout(() => fullscreenContainer.classList.remove('touch-active'), CONTROLS_HIDE_TIMEOUT_MS + 100);
            }
        }, { passive: true });

        // --- Player Creation Functions ---
        function createPlayerContainer(key, isFullscreenContext = false) {
            const ch = channels[key];
            if (!ch) {
                console.error(`Channel config not found for key: ${key}`);
                return null;
            }

            const box = document.createElement('div');
            box.className = 'video-container';
            box.dataset.channelKey = key;

            const loadingIndicator = document.createElement('div');
            loadingIndicator.className = 'loading-indicator';
            loadingIndicator.innerHTML = '<span class="spinner"></span> 注...';
            box.appendChild(loadingIndicator);

            const wantsAudio = (activeAudioKey === key && lastAudioPreference);
            const playerElement = ch.type === 'hls' ? createHlsPlayer(ch, key, loadingIndicator, wantsAudio) 
                                                  : createIframePlayer(ch, wantsAudio, loadingIndicator);

            playerElements[key] = playerElement;
            box.appendChild(playerElement);
            return box;
        }

        function createHlsPlayer(ch, key, loadingIndicator, wantsAudio) {
            const player = document.createElement('video');
            player.autoplay = true;
            player.playsInline = true;
            player.muted = !wantsAudio;
            player.volume = wantsAudio ? 1 : 0;

            if (Hls.isSupported()) {
                const hls = hlsInstances[key] || new Hls({ enableWorker: true, lowLatencyMode: true });
                hlsInstances[key] = hls;

                hls.on(Hls.Events.MANIFEST_PARSED, () => {
                    loadingIndicator.classList.add('hidden');
                    player.play().catch(e => console.warn(`Play failed for ${key}:`, e));
                });

                hls.on(Hls.Events.ERROR, (event, data) => handleHlsError(key, data, hls, ch.url));
                hls.loadSource(ch.url);
                hls.attachMedia(player);
            } else {
                player.src = ch.url;
            }

            player.play().catch(e => console.warn(`Initial play failed for ${key}:`, e));
            return player;
        }

        function createIframePlayer(ch, wantsAudio, loadingIndicator) {
            const iframe = document.createElement('iframe');
            iframe.allow = 'autoplay; fullscreen; encrypted-media';
            iframe.src = buildUrlWithParams(ch.url, !wantsAudio, ch.muteParam);
            iframe.onload = () => loadingIndicator.classList.add('hidden');
            return iframe;
        }

        function handleHlsError(key, data, hls, url) {
            console.error(`HLS error for channel ${key}:`, data);
            if (data.fatal) {
                switch (data.type) {
                    case Hls.ErrorTypes.MEDIA_ERROR:
                        hls.recoverMediaError();
                        break;
                    case Hls.ErrorTypes.NETWORK_ERROR:
                        hls.loadSource(url);
                        break;
                    default:
                        hls.destroy();
                        delete hlsInstances[key];
                        break;
                }
            }
        }

        // --- Player Management Functions ---
        function cleanupPlayer(key) {
            const playerContainer = document.querySelector(`.video-container[data-channel-key="${key}"]`);
            if (playerContainer) {
                const playerElement = playerElements[key];

                if (playerElement && playerElement.tagName === 'VIDEO') {
                    playerElement.pause();
                    playerElement.removeAttribute('src');
                    playerElement.load();
                }

                if (hlsInstances[key]) {
                    hlsInstances[key].destroy();
                    delete hlsInstances[key];
                }

                if (playerContainer.parentNode) {
                    playerContainer.remove();
                }
                delete playerElements[key];
            }
        }

        function cleanupAllPlayers() {
            document.querySelectorAll('.video-container').forEach(container => {
                cleanupPlayer(container.dataset.channelKey);
            });
            fullscreenContainer.innerHTML = '';
            playerElements = {};
            hlsInstances = {};
        }

        function buildUrlWithParams(baseUrl, muted, muteParamName) {
            const url = new URL(baseUrl);
            if (!url.searchParams.has('autoplay')) {
                url.searchParams.set('autoplay', '1');
            }
            if (muteParamName) {
                url.searchParams.set(muteParamName, muted ? '1' : '0');
            }
            return url.toString();
        }

        function updateMuteState(key, shouldBeMuted) {
            const playerElement = playerElements[key];
            const ch = channels[key];

            if (!playerElement || !ch) return;

            if (ch.type === 'hls') {
                playerElement.muted = shouldBeMuted;
                playerElement.volume = shouldBeMuted ? 0 : 1;
                if (!shouldBeMuted && playerElement.paused) {
                    playerElement.play().catch(e => console.warn(`Play failed for ${key} after unmute:`, e));
                }
            } else if (ch.type === 'iframe') {
                const parentContainer = playerElement.parentNode;
                if (parentContainer) {
                    const newIframe = document.createElement('iframe');
                    newIframe.allow = 'autoplay; fullscreen; encrypted-media';
                    newIframe.src = buildUrlWithParams(ch.url, shouldBeMuted, ch.muteParam);
                    newIframe.onload = () => {
                        const loadingIndicator = parentContainer.querySelector('.loading-indicator');
                        if (loadingIndicator) loadingIndicator.classList.add('hidden');
                    };
                    parentContainer.replaceChild(newIframe, playerElement);
                    playerElements[key] = newIframe;
                }
            }
        }

        // --- Audio Management Functions ---
        function setAudioChannel(key) {
            activeAudioKey = key;
            
            for (const pKey in playerElements) {
                if (playerElements.hasOwnProperty(pKey)) {
                    updateMuteState(pKey, !(pKey === activeAudioKey && lastAudioPreference));
                }
            }

            document.querySelectorAll('.video-container').forEach(container => {
                container.classList.toggle('active-audio-highlight', 
                    container.dataset.channelKey === activeAudioKey && lastAudioPreference);
            });

            updateFullscreenMuteButton();
            saveState();
            renderBottomNav();
        }

        function toggleMute() {
            lastAudioPreference = !lastAudioPreference;

            if (fullscreenKey) {
                setAudioChannel(lastAudioPreference ? fullscreenKey : null);
            } else if (activeAudioKey) {
                setAudioChannel(lastAudioPreference ? activeAudioKey : null);
            } else if (activeChannels.length > 0 && lastAudioPreference) {
                setAudioChannel(activeChannels[0]);
            } else {
                setAudioChannel(null);
            }
            
            updateFullscreenMuteButton();
            saveState();
            renderBottomNav();
        }

        function updateFullscreenMuteButton() {
            const muteButton = document.getElementById('fs-mute-btn');
            if (muteButton) {
                muteButton.innerHTML = feather.icons[lastAudioPreference ? 'volume-2' : 'volume-x'].toSvg();
            }
        }

        // --- Rendering Functions ---
        function renderGrid() {
            grid.innerHTML = '';
            message.classList.toggle('hidden', activeChannels.length > 0);

            activeChannels.forEach(key => {
                let playerContainer = document.querySelector(`.video-container[data-channel-key="${key}"]`);
                if (!playerContainer) {
                    playerContainer = createPlayerContainer(key, false);
                } else {
                    playerContainer.style.display = '';
                }
                grid.appendChild(playerContainer);

                updateMuteState(key, !(key === activeAudioKey && lastAudioPreference));

                const overlay = document.createElement('div');
                overlay.className = 'grid-controls-overlay';
                overlay.innerHTML = `
                    <div class="channel-name-bar">${channels[key].name}</div>
                    <div class="grid-control-buttons">
                        <button class="control-btn" data-action="audio">
                            ${key === activeAudioKey && lastAudioPreference ? feather.icons['volume-2'].toSvg() : feather.icons['volume-x'].toSvg()}
                        </button>
                        <button class="control-btn" data-action="fullscreen">
                            ${feather.icons['maximize'].toSvg()}
                        </button>
                        <button class="control-btn" data-action="remove">
                            ${feather.icons['x'].toSvg()}
                        </button>
                    </div>
                `;
                playerContainer.appendChild(overlay);

                overlay.querySelector('[data-action="audio"]').addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (activeAudioKey === key && lastAudioPreference) {
                        lastAudioPreference = false;
                        setAudioChannel(null);
                    } else {
                        lastAudioPreference = true;
                        setAudioChannel(key);
                    }
                });
                overlay.querySelector('[data-action="fullscreen"]').addEventListener('click', (e) => {
                    e.stopPropagation();
                    enterFullscreen(key);
                });
                overlay.querySelector('[data-action="remove"]').addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleChannel(key);
                });

                playerContainer.classList.toggle('active-audio-highlight', 
                    key === activeAudioKey && lastAudioPreference);
            });

            document.querySelectorAll('.video-container').forEach(container => {
                const key = container.dataset.channelKey;
                if (!activeChannels.includes(key) && container.parentNode === grid) {
                    cleanupPlayer(key);
                }
            });
        }

        function renderFullscreen() {
            fullscreenContainer.innerHTML = '';

            if (fullscreenKey) {
                const ch = channels[fullscreenKey];
                if (!ch) {
                    exitFullscreen();
                    return;
                }

                const fsPlayerContainer = createPlayerContainer(fullscreenKey, true);
                fullscreenContainer.appendChild(fsPlayerContainer);
                updateMuteState(fullscreenKey, !lastAudioPreference);

                const fsControls = document.createElement('div');
                fsControls.id = 'fullscreen-controls';
                fsControls.innerHTML = `
                    <div class="fullscreen-top-controls">
                        <span class="fullscreen-channel-name">${ch.name}</span>
                    </div>
                    <div class="fullscreen-bottom-controls">
                        <button id="fs-prev-btn" class="fs-btn">${feather.icons['chevron-right'].toSvg()}</button>
                        <div class="fullscreen-center-buttons">
                            <button id="fs-mute-btn" class="fs-btn">${lastAudioPreference ? feather.icons['volume-2'].toSvg() : feather.icons['volume-x'].toSvg()}</button>
                            <button id="fs-exit-btn" class="fs-btn">${feather.icons['minimize'].toSvg()}</button>
                        </div>
                        <button id="fs-next-btn" class="fs-btn">${feather.icons['chevron-left'].toSvg()}</button>
                    </div>
                `;
                fullscreenContainer.appendChild(fsControls);

                document.getElementById('fs-exit-btn').addEventListener('click', exitFullscreen);
                document.getElementById('fs-mute-btn').addEventListener('click', toggleMute);
                document.getElementById('fs-prev-btn').addEventListener('click', () => switchFullscreenChannel(-1));
                document.getElementById('fs-next-btn').addEventListener('click', () => switchFullscreenChannel(1));

                showFullscreenControls();
            }
        }

        function renderBottomNav() {
            bottomNavContainer.innerHTML = '';
            Object.keys(channels).forEach(key => {
                const ch = channels[key];
                const button = document.createElement('button');
                button.className = `channel-button ${activeChannels.includes(key) ? 'active' : ''}`;
                button.dataset.channelKey = key;
                button.innerHTML = `
                    ${ch.short}
                    ${activeAudioKey === key && lastAudioPreference ? '<span class="audio-indicator"></span>' : ''}
                `;
                button.addEventListener('click', () => toggleChannel(key));
                bottomNavContainer.appendChild(button);
            });
        }

        // --- Channel Management Functions ---
        function toggleChannel(key) {
            const index = activeChannels.indexOf(key);
            if (index > -1) {
                activeChannels.splice(index, 1);
                if (activeAudioKey === key) setAudioChannel(null);
                if (fullscreenKey === key) exitFullscreen();
                cleanupPlayer(key);
            } else {
                activeChannels.push(key);
                if (!activeAudioKey) setAudioChannel(key);
            }
            saveState();
            renderGrid();
            renderBottomNav();
        }

        function enterFullscreen(key) {
            fullscreenKey = key;
            document.body.classList.add('fullscreen-mode');
            
            for (const pKey in playerElements) {
                if (playerElements.hasOwnProperty(pKey) && pKey !== fullscreenKey) {
                    updateMuteState(pKey, true);
                }
            }
            
            setAudioChannel(lastAudioPreference ? key : null);
            renderFullscreen();
            saveState();
            
            if (fullscreenContainer.requestFullscreen) {
                fullscreenContainer.requestFullscreen();
            } else if (fullscreenContainer.mozRequestFullScreen) {
                fullscreenContainer.mozRequestFullScreen();
            } else if (fullscreenContainer.webkitRequestFullscreen) {
                fullscreenContainer.webkitRequestFullscreen();
            } else if (fullscreenContainer.msRequestFullscreen) {
                fullscreenContainer.msRequestFullscreen();
            }
        }

        function exitFullscreen() {
            document.body.classList.remove('fullscreen-mode');
            fullscreenKey = null;
            renderFullscreen();

            if (activeAudioKey && lastAudioPreference) {
                updateMuteState(activeAudioKey, false);
            }
            renderGrid();
            saveState();

            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
        }

        function switchFullscreenChannel(direction) {
            if (!fullscreenKey || activeChannels.length === 0) return;

            const currentIndex = activeChannels.indexOf(fullscreenKey);
            if (currentIndex === -1) {
                fullscreenKey = activeChannels[0];
                renderFullscreen();
                setAudioChannel(lastAudioPreference ? fullscreenKey : null);
                saveState();
                return;
            }

            let newIndex = currentIndex + direction;
            if (newIndex >= activeChannels.length) newIndex = 0;
            else if (newIndex < 0) newIndex = activeChannels.length - 1;

            const newFullscreenKey = activeChannels[newIndex];
            if (newFullscreenKey !== fullscreenKey) {
                fullscreenKey = newFullscreenKey;
                setAudioChannel(lastAudioPreference ? fullscreenKey : null);
                renderFullscreen();
                saveState();
            }
        }

        // --- Event Listeners ---
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement && !document.webkitFullscreenElement && 
                !document.mozFullScreenElement && !document.msFullscreenElement) {
                if (document.body.classList.contains('fullscreen-mode')) {
                    exitFullscreen();
                }
            } else {
                if (!document.body.classList.contains('fullscreen-mode') && activeChannels.length > 0) {
                    if (!fullscreenKey) fullscreenKey = activeChannels[0];
                    document.body.classList.add('fullscreen-mode');
                    setAudioChannel(lastAudioPreference ? fullscreenKey : null);
                    renderFullscreen();
                    saveState();
                }
            }
        });

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            renderGrid();
            renderBottomNav();

            if (fullscreenKey && activeChannels.includes(fullscreenKey)) {
                enterFullscreen(fullscreenKey);
            } else if (fullscreenKey) {
                fullscreenKey = null;
                saveState();
            }

            setAudioChannel(activeAudioKey);
        });
    </script>
</body>
</html>
