<!DOCTYPE html>
<html>
<head>
    <title>רדיו אינטרנטי</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            font-size: 16px;
            cursor: pointer;
        }
        #cast-button {
            background-color: #4CAF50;
            color: white;
            border: none;
        }
        #status {
            margin-top: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>רדיו אינטרנטי</h1>

    <div id="stations">
        <!-- תחנות רדיו יתווספו כאן -->
    </div>

    <button id="cast-button">התחבר לכרומקאסט</button>

    <audio id="audio-player" controls autoplay style="display: none;"></audio>

    <div id="status">מוכן</div>

    <script>
        // הגדרות תחנות רדיו
        const stations = [
            {
                "id": "station-kan",
                "name": "כאן ב'",
                "url": "https://28503.live.streamtheworld.com/KAN_BET.mp3?dist=radio2net"
            },
            {
                "id": "station-glz",
                "name": "גלי צהל",
                "url": "https://glzwizzlv.bynetcdn.com/glz_mp3?awCollectionId=misc&awEpisodeId=glz"
            },
            {
                "id": "glyisrael",
                "name": "גלי ישראל",
                "url": "https://cdn.cybercdn.live/Galei_Israel/Live/icecast.audio"
            }
        ];

        let currentStation = null;
        let castSession = null;
        let castPlayer = null;
        let castContext = null;
        let inactivityTimer = null;
        const INACTIVITY_TIMEOUT = 30 * 60 * 1000; // 30 דקות

        const audioPlayer = document.getElementById('audio-player');
        const stationsDiv = document.getElementById('stations');
        const castButton = document.getElementById('cast-button');
        const statusDiv = document.getElementById('status');

        // פונקציה ליצירת כפתור תחנה
        function createStationButton(station) {
            const button = document.createElement('button');
            button.textContent = station.name;
            button.id = station.id;
            button.addEventListener('click', () => playStation(station));
            return button;
        }

        // הוספת תחנות רדיו לממשק
        stations.forEach(station => {
            const button = createStationButton(station);
            stationsDiv.appendChild(button);
        });

        // פונקציה להפעלת תחנה
        function playStation(station) {
            if (currentStation === station) {
                stopCast(); // עצירת שידור בכרומקאסט אם התחנה כבר מתנגנת
                return;
            }

            currentStation = station;

            // עצירת תחנה קודמת
            if (audioPlayer.src) {
                audioPlayer.pause();
                audioPlayer.src = '';
            }

            // הפעלת התחנה החדשה
            audioPlayer.src = station.url;
            audioPlayer.play();

            // עדכון סטטוס כפתורים
            updateButtonStatus(station.id, 'מנגן במכשיר');

            // איפוס טיימר חוסר פעילות
            resetInactivityTimer();

            // שידור לכרומקאסט אם מחובר
            if (castSession) {
                castMedia(station.url);
            }
        }

        // פונקציה לעדכון סטטוס כפתור
        function updateButtonStatus(stationId, status) {
            stations.forEach(station => {
                const button = document.getElementById(station.id);
                if (station.id === stationId) {
                    button.textContent = `${station.name} (${status})`;
                } else {
                    button.textContent = station.name; // איפוס טקסט לכפתורים אחרים
                }
            });
        }

        // פונקציות כרומקאסט
        function initializeCastApi() {
            castContext = cast.framework.CastContext.getInstance();
            castContext.setOptions({
                receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
            });

            castButton.addEventListener('click', connectToCast);

             castContext.addEventListener(
                cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
                function(event) {
                  switch (event.sessionState) {
                    case cast.framework.SessionState.SESSION_STARTED:
                      console.log('Cast Session Started');
                      castSession = castContext.getCurrentSession();
                      castPlayer = new cast.framework.RemotePlayer();
                      castRemotePlayerController = new cast.framework.RemotePlayerController(castPlayer);
                      castMedia(currentStation.url); // התחלת שידור בכרומקאסט לאחר חיבור
                      break;
                    case cast.framework.SessionState.SESSION_ENDED:
                      console.log('Cast Session Ended');
                      castSession = null;
                      castPlayer = null;
                      castRemotePlayerController = null;
                      updateButtonStatus(currentStation.id, 'מנגן במכשיר');
                      break;
                  }
                });
        }


        function connectToCast() {
             castContext.requestSession()
              .then(function(session) {
                castSession = session;
                console.log('Connected to Chromecast');
                castMedia(currentStation.url);

              })
              .catch(function(error) {
                console.error('Error connecting to Chromecast:', error);
                statusDiv.textContent = 'שגיאה: לא ניתן להתחבר לכרומקאסט. אנא ודא שהכרומקאסט זמין ובאותה רשת.';
              });
        }

        function castMedia(mediaURL) {
            if (!castSession) {
                statusDiv.textContent = 'לא מחובר לכרומקאסט';
                return;
            }

            const mediaInfo = new chrome.cast.media.MediaInfo(mediaURL, 'audio/mp3');
            mediaInfo.metadata = new chrome.cast.media.MusicTrackMediaMetadata();
            mediaInfo.metadata.artist = 'רדיו אינטרנטי';
            mediaInfo.metadata.title = currentStation.name;
            mediaInfo.metadata.albumName = 'שידור חי';

            const request = new chrome.cast.media.LoadRequest(mediaInfo);
            castSession.loadMedia(request)
                .then(function() {
                    console.log('Loading started');
                    updateButtonStatus(currentStation.id, 'מנגן בכרומקאסט');
                })
                .catch(function(error) {
                    console.error('Media load failed', error);
                    statusDiv.textContent = 'שגיאה בטעינת המדיה לכרומקאסט';
                });
        }

        function stopCast() {
            if (castSession) {
                castSession.endSession(true)
                    .then(function() {
                        console.log('Session ended');
                        updateButtonStatus(currentStation.id, 'מופסק');
                    })
                    .catch(function(error) {
                        console.error('Error ending session', error);
                    });
            }
        }

        // טיימר חוסר פעילות
        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            inactivityTimer = setTimeout(() => {
                disconnectFromCast();
            }, INACTIVITY_TIMEOUT);
        }

        function disconnectFromCast() {
            if (castSession) {
                castSession.endSession(true);
                castSession = null;
                statusDiv.textContent = 'הכרומקאסט התנתק עקב חוסר פעילות';
            }
        }

        // טיפול בהפרעות חיצוניות (צריך בדיקה נוספת - תלוי במימוש של Cast SDK)
        // (יש צורך ב API כדי לבדוק סטטוס נוכחי של הכרומקאסט)
        // function handleCastInterruption() {
        //     audioPlayer.pause();
        //     audioPlayer.src = '';
        //     updateButtonStatus(currentStation.id, 'מופסק');
        //     statusDiv.textContent = 'השידור הופסק על ידי מכשיר אחר';
        //     resetInactivityTimer();
        // }


        // אתחול ה-Cast API כאשר הדף נטען
        window.onload = function() {
            if (chrome.cast && chrome.cast.isAvailable) {
                 cast.framework.CastContext.getInstance().setOptions({
                        receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                        autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                });
                initializeCastApi();
            } else {
                setTimeout(initializeCastApi, 1000);
            }
        };

    </script>
    <script src="//www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
</body>
</html>
