<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>רדיו נגיש</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 20px;
            color: #333;
        }

        .station-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 10px;
            background-color: #fff;
            width: 80%;
            max-width: 500px;
        }

        .station-button {
            padding: 15px 30px;
            font-size: 1.5em;
            margin: 10px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
            width: 100%;
            text-align: center;
            display: block;
        }

        .station-button:hover {
            background-color: #0056b3;
        }

        audio {
            width: 100%;
            margin-top: 10px;
        }

        #cast-button {
            padding: 15px 30px;
            font-size: 1.5em;
            margin: 20px;
            border: none;
            border-radius: 5px;
            background-color: #28a745;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #cast-button:hover {
            background-color: #1e7e34;
        }

        #cast-button.on {
            background-color: #dc3545; /* צבע אדום כשהשידור במכשיר */
        }

        .hidden {
            display: none;
        }

        #status {
            margin-top: 20px;
            font-size: 1.2em;
            color: #555;
        }

        @media (max-width: 600px) {
            .station-button {
                font-size: 1.2em;
                padding: 10px 20px;
            }

            h1 {
                font-size: 2em;
            }
        }
    </style>
</head>
<body>
    <h1>רדיו נגגגגיש</h1>

    <div class="station-container">
        <h2>כאן ב'</h2>
        <button class="station-button" data-url="https://28503.live.streamtheworld.com/KAN_BET.mp3?dist=radio2net" onclick="playStation(this)">הפעל כאן ב'</button>
    </div>

    <div class="station-container">
        <h2>גלי צהל</h2>
        <button class="station-button" data-url="https://glzwizzlv.bynetcdn.com/glz_mp3?awCollectionId=misc&awEpisodeId=glz" onclick="playStation(this)">הפעל גלי צהל</button>
    </div>

    <div class="station-container">
        <h2>גלי ישראל</h2>
        <button class="station-button" data-url="https://cdn.cybercdn.live/Galei_Israel/Live/icecast.audio" onclick="playStation(this)">הפעל גלי ישראל</button>
    </div>

    <audio id="audio-player" controls autoplay></audio>

    <button id="cast-button" onclick="toggleCast()">העבר לכרוםקאסט</button>
    <div id="status"></div>

    <script>
        let currentStationURL = null;
        let audioPlayer = document.getElementById('audio-player');
        let castButton = document.getElementById('cast-button');
        let statusDiv = document.getElementById('status');
        let castSession = null;
        let isCasting = false;
        let currentStationButton = null; // כפתור התחנה הנוכחית

        // Initialize Chromecast SDK
        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                initializeCastApi();
            } else {
                statusDiv.innerText = "Chromecast לא זמין.";
            }
        };

        function initializeCastApi() {
            let applicationID = chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID;
            let sessionRequest = new chrome.cast.SessionRequest(applicationID);
            let apiConfig = new chrome.cast.ApiConfig(sessionRequest,
                sessionListener,
                receiverListener);

            chrome.cast.initialize(apiConfig, onInitSuccess, onError);
        }

        function onInitSuccess() {
            console.log('Chromecast API initialized');
        }

        function onError(message) {
            console.error('Chromecast initialization error: ' + message);
            statusDiv.innerText = "שגיאה בהפעלת Chromecast: " + message;
        }

        function sessionListener(session) {
            console.log('New session ID: ' + session.sessionId);
            castSession = session;

            castSession.addUpdateListener(sessionUpdateListener);
        }

        function sessionUpdateListener(isAlive) {
            if (!isAlive) {
                castSession = null;
                isCasting = false;
                castButton.classList.remove('on');
                statusDiv.innerText = "Chromecast מנותק.";
            }
        }

        function receiverListener(availability) {
            if (availability === chrome.cast.ReceiverAvailability.AVAILABLE) {
                console.log('Chromecast receiver available');
            } else {
                console.log('Chromecast receiver unavailable');
                statusDiv.innerText = "Chromecast לא זמין.";
            }
        }

        function playStation(button) {
            let newStationURL = button.dataset.url;

            // אם לוחצים על אותה תחנה שמשודרת, עוצרים את השידור
            if (currentStationURL === newStationURL && (audioPlayer.src || isCasting)) {
                stopPlaying();
                return;
            }

            currentStationURL = newStationURL;

            // שמירת הכפתור של התחנה הנוכחית
            currentStationButton = button;

            if (isCasting && castSession) {
                loadMedia(currentStationURL);
            } else {
                audioPlayer.src = currentStationURL;
                audioPlayer.play();
                statusDiv.innerText = "מנגן: " + button.innerText.replace('הפעל ', '');
            }
        }

        function toggleCast() {
            if (isCasting) {
                stopCast();
            } else {
                castMedia();
            }
        }

        function castMedia() {
            if (!currentStationURL) {
                statusDiv.innerText = "בחר תחנה קודם.";
                return;
            }

            if (castSession) {
                loadMedia(currentStationURL);
            } else {
                chrome.cast.requestSession(
                    function(session) {
                        console.log('Session acquired: ' + session.sessionId);
                        castSession = session;
                        loadMedia(currentStationURL);
                    },
                    function(err) {
                        statusDiv.innerText = "שגיאה ביצירת חיבור לכרוםקאסט: " + err;
                        console.error('Error launching session: ' + err);
                    }
                );
            }
        }

        function loadMedia(mediaURL) {
            let mediaInfo = new chrome.cast.media.MediaInfo(mediaURL, 'audio/mp3');
            mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
            mediaInfo.metadata.metadataType = chrome.cast.media.MetadataType.GENERIC;
            mediaInfo.metadata.title = 'רדיו נגיש';

            let request = new chrome.cast.media.LoadRequest(mediaInfo);
            request.autoplay = true;

            castSession.loadMedia(request,
                function() {
                    statusDiv.innerText = "השידור הועבר לכרוםקאסט.";
                    isCasting = true;
                    castButton.classList.remove('on');
                    audioPlayer.pause();
                },
                function(errorCode) {
                    statusDiv.innerText = "שגיאה בהעברת השידור לכרוםקאסט: " + errorCode;
                    console.error('Error launching media: ' + errorCode);
                }
            );
        }

        function stopCast() {
            castSession.stop(
                function() {
                    console.log('Session stopped');
                    isCasting = false;
                    castButton.classList.add('on'); // משנה צבע
                    statusDiv.innerText = "השידור חזר למכשיר.";
                    audioPlayer.play(); // מפעיל את הנגן המקומי
                    audioPlayer.src = currentStationURL; // מוודא שהנגן המקומי מנגן את התחנה הנכונה
                },
                function(errorCode) {
                    statusDiv.innerText = "שגיאה בעצירת השידור בכרוםקאסט: " + errorCode;
                    console.error('Error stopping cast: ' + errorCode);
                }
            );
        }

        function stopPlaying() {
            if (isCasting && castSession) {
                stopCast(); // אם משדרים לכרוםקאסט, נעצור אותו
            } else {
                audioPlayer.pause(); // עוצרים את הנגן המקומי
                audioPlayer.src = ''; // מנקים את מקור השמע
                currentStationURL = null; // מנקים את כתובת התחנה הנוכחית
                statusDiv.innerText = "השידור הופסק.";
            }
        }
    </script>
    <script src="//www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
</body>
</html>
