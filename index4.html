<!DOCTYPE html>
<html lang="he">
<head>
    <!-- קוד קיים של Google Tag Manager נשאר כפי שהוא -->
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>אפליקציית תחנות רדיו</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="apple-touch-icon" href="icon.png">
    <!-- הוספת ספריית Cast -->
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <style>
        /* הוספת סגנון לכפתור Cast */
        .cast-button {
            background: none;
            border: none;
            padding: 10px;
            cursor: pointer;
            margin: 10px 0;
        }
        
        .cast-button img {
            width: 32px;
            height: 32px;
        }
        
        /* שאר הסגנונות נשארים כפי שהם */
        /* ... */
    </style>
</head>
<body>
    <!-- תוכן קיים נשאר -->
    <div class="container">
        <audio id="audio-player">
            <source src="http://kanliveicy.media.kan.org.il/kanbet_mp3" type="audio/mpeg">
            הדפדפן שלך לא תומך בהשמעת אודיו.
        </audio>
        
        <h4>רדיו נגיש עבור אבא</h4>
        <div>לחץ ובחר תחנה להאזנה</div>
        
        <!-- הוספת כפתור Cast -->
        <button id="castButton" class="cast-button">
            <img src="https://www.gstatic.com/images/icons/material/system/2x/cast_white_24dp.png" alt="Cast">
        </button>
        
        <!-- שאר התוכן נשאר כפי שהוא -->
        <!-- ... -->
    </div>

    <script>
        let castSession = null;
        let castPlayer = null;
        
        // אתחול Cast
        window['__onGCastApiAvailable'] = function(isAvailable) {
            if (isAvailable) {
                initializeCastApi();
            }
        };

        function initializeCastApi() {
            cast.framework.CastContext.getInstance().setOptions({
                receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
            });
            
            const context = cast.framework.CastContext.getInstance();
            context.addEventListener(
                cast.framework.CastContextEventType.SESSION_STATE_CHANGED,
                event => {
                    if (event.sessionState === cast.framework.SessionState.SESSION_STARTED) {
                        castSession = context.getCurrentSession();
                    } else if (event.sessionState === cast.framework.SessionState.SESSION_ENDED) {
                        castSession = null;
                    }
                }
            );
        }

        // פונקציה חדשה להעברת השמע ל-Chromecast
        async function castAudio(url) {
            if (!castSession) {
                const context = cast.framework.CastContext.getInstance();
                castSession = await context.requestSession();
            }

            const mediaInfo = new chrome.cast.media.MediaInfo(url, 'audio/mp3');
            mediaInfo.metadata = new chrome.cast.media.GenericMediaMetadata();
            mediaInfo.metadata.title = 'רדיו';

            const request = new chrome.cast.media.LoadRequest(mediaInfo);
            try {
                castPlayer = await castSession.loadMedia(request);
            } catch (error) {
                console.error('Error loading media: ', error);
            }
        }

        // עדכון פונקציית החלפת תחנה
        async function switchStation(button) {
            const url = button.getAttribute('data-url');
            if (currentStationButton === button) {
                if (castSession) {
                    castSession.endSession(true);
                } else {
                    audioPlayer.pause();
                }
                audioPlayer.currentTime = 0;
                button.classList.remove('active');
                currentStationButton = null;
                return;
            }

            if (castSession) {
                await castAudio(url);
            } else {
                audioPlayer.src = url;
                audioPlayer.volume = radioVolume;
                audioPlayer.play();
            }

            if (currentStationButton) {
                currentStationButton.classList.remove('active');
            }
            button.classList.add('active');
            currentStationButton = button;
        }

        // הוספת מאזין לכפתור Cast
        document.getElementById('castButton').addEventListener('click', async () => {
            if (!castSession) {
                try {
                    const context = cast.framework.CastContext.getInstance();
                    await context.requestSession();
                    if (currentStationButton) {
                        const url = currentStationButton.getAttribute('data-url');
                        await castAudio(url);
                        audioPlayer.pause();
                    }
                } catch (error) {
                    console.error('Error starting cast session: ', error);
                }
            } else {
                castSession.endSession(true);
                if (currentStationButton) {
                    const url = currentStationButton.getAttribute('data-url');
                    audioPlayer.src = url;
                    audioPlayer.play();
                }
            }
        });

        // שאר הקוד נשאר כפי שהוא
        // ...
    </script>
</body>
</html>
