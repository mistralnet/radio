<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>רדיו ישראלי</title>
    <script src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; text-align: center; }
        .stations { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; }
        .station-btn { padding: 10px; background-color: #f0f0f0; border: none; cursor: pointer; }
        .active { background-color: #4CAF50; color: white; }
        #status { margin: 15px 0; font-weight: bold; }
        .controls { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
    </style>
</head>
<body>
    <div id="status">לחץ על תחנה להתחלת השידור</div>
    <div class="stations" id="stations"></div>
    <div class="controls">
        <button id="castButton" onclick="initializeCastApi()">שידור לכרומקאסט</button>
        <button onclick="changeVolume(-0.1)">הנמך קול</button>
        <button onclick="changeVolume(0.1)">הגבר קול</button>
    </div>

    <audio id="radioPlayer"></audio>

    <script>
        const stations = [
            {"id": "station-kan", "name": "כאן ב'", "url": "https://kan-16.cast.mmdlive.lldns.net/kan/live_b/kan_b/index.m3u8"},
            {"id": "station-glz", "name": "גלי צהל", "url": "https://glzwizzlv.bynetcdn.com/glz_mp3"},
            {"id": "glyisrael", "name": "גלי ישראל", "url": "https://stream.hari.fm:2199/rpc/gali/stream.php?type=.mp3"}
        ];

        const player = document.getElementById('radioPlayer');
        const statusDisplay = document.getElementById('status');
        const stationsContainer = document.getElementById('stations');
        const castButton = document.getElementById('castButton');
        let currentStation = null;
        let castContext = null;
        let castSession = null;

        function renderStations() {
            stations.forEach(station => {
                const btn = document.createElement('button');
                btn.textContent = station.name;
                btn.className = 'station-btn';
                btn.id = station.id;
                btn.onclick = () => playStation(station);
                stationsContainer.appendChild(btn);
            });
        }

        function playStation(station) {
            if (currentStation) {
                document.getElementById(currentStation.id).classList.remove('active');
            }

            player.src = station.url;
            player.play().catch(error => {
                statusDisplay.textContent = `שגיאה: ${error.message}`;
            });

            currentStation = station;
            document.getElementById(station.id).classList.add('active');
            statusDisplay.textContent = `משדר: ${station.name}`;

            if (castSession && castSession.isConnected()) {
                loadMedia(station.url);
            }
        }

        function initializeCastApi() {
            if (!castContext) {
                castContext = cast.framework.CastContext.getInstance();
                castContext.setOptions({
                    receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                });
            }

            castContext.requestSession().then(
                session => {
                    castSession = session;
                    statusDisplay.textContent = 'מחובר לכרומקאסט';
                    if (currentStation) {
                        loadMedia(currentStation.url);
                    }
                },
                error => {
                    statusDisplay.textContent = `שגיאת חיבור: ${error}`;
                }
            );
        }

        function loadMedia(url) {
            const mediaInfo = new chrome.cast.media.MediaInfo(url, 'audio/mp3');
            const request = new chrome.cast.media.LoadRequest(mediaInfo);
            
            castSession.loadMedia(request).then(
                () => {
                    statusDisplay.textContent = `משדר ב-Chromecast: ${currentStation.name}`;
                },
                error => {
                    statusDisplay.textContent = `שגיאת טעינת מדיה: ${error}`;
                }
            );
        }

        function changeVolume(delta) {
            if (castSession && castSession.isConnected()) {
                const currentVolume = castSession.getMediaSession().getVolume();
                const newVolume = Math.max(0, Math.min(1, currentVolume + delta));
                castSession.setVolume(newVolume);
            } else {
                player.volume = Math.max(0, Math.min(1, player.volume + delta));
            }
        }

        window.__onGCastApiAvailable = (loaded, errorInfo) => {
            if (loaded) {
                initializeCastApi();
            } else {
                statusDisplay.textContent = `שגיאת Cast API: ${errorInfo}`;
            }
        };

        renderStations();
    </script>
</body>
</html>
