<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>צפייה בערוצי שידור</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { direction: rtl; }
        .video-container { position: relative; width: 100%; height: 100%; }
        .media-controls { 
            position: absolute; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: rgba(0,0,0,0.7); 
            padding: 10px; 
            border-radius: 8px; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            opacity: 0; 
            transition: opacity 0.3s; 
            z-index: 10;
        }
        .video-container:hover .media-controls, .video-container:focus-within .media-controls { opacity: 1; }
        .media-btn { 
            background: none; 
            border: none; 
            color: white; 
            cursor: pointer; 
            font-size: 1.2rem; 
            padding: 5px;
        }
        .progress-container {
            flex-grow: 1;
            height: 5px;
            background: #444;
            border-radius: 5px;
            cursor: pointer;
            position: relative;
        }
        .progress-bar {
            height: 100%;
            background: #1F6FEB;
            border-radius: 5px;
            width: 0;
        }
        .volume-slider {
            width: 80px;
            accent-color: #1F6FEB;
        }
        .grid-container {
            display: grid;
            gap: 10px;
            height: calc(100vh - 120px);
        }
        .channel-button {
            padding: 8px 16px;
            background-color: #4B5563;
            color: white;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .channel-button.active {
            background-color: #1F6FEB;
        }
        .channel-button:hover {
            background-color: #6B7280;
        }
        .autoplay-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }
        @media (min-width: 768px) {
            .grid-1 { grid-template-columns: 1fr; }
            .grid-2 { grid-template-columns: repeat(2, 1fr); }
            .grid-3 { grid-template-columns: repeat(2, 1fr); }
            .grid-4 { grid-template-columns: repeat(2, 1fr); }
        }
        @media (max-width: 767px) {
            .grid-1, .grid-2, .grid-3, .grid-4 { grid-template-columns: 1fr; }
        }
        .fullscreen .media-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <div class="p-4">
        <h1 class="text-2xl font-bold mb-4 text-center">בחר ערוצי שידור</h1>
        <div class="flex justify-center gap-4 mb-4 flex-wrap">
            <button class="channel-button" data-channel="kan11">כאן 11</button>
            <button class="channel-button" data-channel="now14">עכשיו 14</button>
            <button class="channel-button" data-channel="i24news">i24NEWS</button>
            <button class="channel-button" data-channel="news12">חדשות 12</button>
            <button class="channel-button" data-channel="news13">חדשות 13</button>
        </div>
        <div id="video-grid" class="grid-container"></div>
    </div>

    <script>
        /**
         * @typedef {Object} Channel
         * @property {string} type - Stream type ('hls' or 'iframe')
         * @property {string} url - Stream URL
         * @property {string} name - Channel name
         */

        /** @type {Object.<string, Channel>} */
        const channels = {
            kan11: { type: 'hls', url: 'https://kan11w.media.kan.org.il/hls/live/2105694/2105694/source1_4k/chunklist.m3u8', name: 'כאן 11' },
            now14: { type: 'iframe', url: 'https://www.now14.co.il/live/?autoplay=1&mute=1&autoPlay=true&muted=true', name: 'עכשיו 14' },
            i24news: { type: 'hls', url: 'https://bcovlive-a.akamaihd.net/d89ede8094c741b7924120b27764153c/eu-central-1/5377161796001/profile_0/chunklist.m3u8', name: 'i24NEWS' },
            news12: { type: 'iframe', url: 'https://www.mako.co.il/mako-vod-live-tv/VOD-6540b8dcb64fd31006.htm?autoplay=1&muted=true&autoPlay=true', name: 'חדשות 12' },
            news13: { type: 'hls', url: 'https://d198ztbnlup2iq.cloudfront.net/out/v1/2d9050c90fb94df8b78d1d98306a1a65/index.m3u8', name: 'חדשות 13' }
        };

        const videoGrid = document.getElementById('video-grid');
        const buttons = document.querySelectorAll('.channel-button');
        let activeChannels = JSON.parse(localStorage.getItem('activeChannels') || '[]');

        /**
         * Saves active channels to localStorage
         */
        function saveActiveChannels() {
            localStorage.setItem('activeChannels', JSON.stringify(activeChannels));
        }

        /**
         * Creates a video player for the specified channel.
         * @param {string} channelKey - The channel identifier.
         * @returns {HTMLElement} The video container element.
         */
        function createVideoPlayer(channelKey) {
            const channel = channels[channelKey];
            const container = document.createElement('div');
            container.className = 'video-container';
            container.dataset.channel = channelKey;

            if (channel.type === 'hls') {
                const video = document.createElement('video');
                video.className = 'w-full h-full';
                video.controls = false;
                video.muted = true;
                container.appendChild(video);

                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(channel.url);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => {
                        video.play().catch(() => showAutoplayOverlay(container, video));
                    });
                    hls.on(Hls.Events.ERROR, () => {
                        showAutoplayOverlay(container, video);
                    });
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = channel.url;
                    video.addEventListener('loadedmetadata', () => {
                        video.play().catch(() => showAutoplayOverlay(container, video));
                    });
                }

                video.addEventListener('click', () => {
                    if (video.paused) video.play();
                    else video.pause();
                });

                video.addEventListener('play', () => {
                    const overlay = container.querySelector('.autoplay-overlay');
                    if (overlay) overlay.remove();
                });

                initMediaControls(container, video);
            } else {
                const iframe = document.createElement('iframe');
                iframe.className = 'w-full h-full';
                iframe.src = channel.url;
                iframe.allow = 'autoplay; fullscreen';
                iframe.setAttribute('allowfullscreen', '');
                container.appendChild(iframe);
                initIframeControls(container, iframe);
            }

            return container;
        }

        /**
         * Initializes media controls for a video element.
         * @param {HTMLElement} container - The video container.
         * @param {HTMLVideoElement} video - The video element.
         */
        function initMediaControls(container, video) {
            const controls = document.createElement('div');
            controls.className = 'media-controls';

            // Play/Pause Button
            const playPauseBtn = document.createElement('button');
            playPauseBtn.className = 'media-btn';
            playPauseBtn.innerHTML = '<i class="fa fa-pause"></i>';
            playPauseBtn.setAttribute('aria-label', 'השהה');
            playPauseBtn.addEventListener('click', () => {
                if (video.paused) {
                    video.play().catch(() => showAutoplayOverlay(container, video));
                    playPauseBtn.innerHTML = '<i class="fa fa-pause"></i>';
                    playPauseBtn.setAttribute('aria-label', 'השהה');
                } else {
                    video.pause();
                    playPauseBtn.innerHTML = '<i class="fa fa-play"></i>';
                    playPauseBtn.setAttribute('aria-label', 'הפעל');
                }
            });

            // Stop Button
            const stopBtn = document.createElement('button');
            stopBtn.className = 'media-btn';
            stopBtn.innerHTML = '<i class="fa fa-stop"></i>';
            stopBtn.setAttribute('aria-label', 'עצור');
            stopBtn.addEventListener('click', () => {
                video.pause();
                video.currentTime = 0;
                playPauseBtn.innerHTML = '<i class="fa fa-play"></i>';
                playPauseBtn.setAttribute('aria-label', 'הפעל');
            });

            // Volume Slider
            const volumeSlider = document.createElement('input');
            volumeSlider.type = 'range';
            volumeSlider.className = 'volume-slider';
            volumeSlider.min = '0';
            volumeSlider.max = '1';
            volumeSlider.step = '0.1';
            volumeSlider.value = video.volume;
            volumeSlider.setAttribute('aria-label', 'שליטה בעוצמת הקול');
            volumeSlider.addEventListener('input', () => {
                video.volume = volumeSlider.value;
                video.muted = volumeSlider.value == 0;
                muteBtn.innerHTML = video.muted ? '<i class="fa fa-volume-mute"></i>' : '<i class="fa fa-volume-up"></i>';
                muteBtn.setAttribute('aria-label', video.muted ? 'בטל השתקה' : 'השתק');
            });

            // Mute Button
            const muteBtn = document.createElement('button');
            muteBtn.className = 'media-btn';
            muteBtn.innerHTML = '<i class="fa fa-volume-up"></i>';
            muteBtn.setAttribute('aria-label', 'השתק');
            muteBtn.addEventListener('click', () => {
                video.muted = !video.muted;
                muteBtn.innerHTML = video.muted ? '<i class="fa fa-volume-mute"></i>' : '<i class="fa fa-volume-up"></i>';
                muteBtn.setAttribute('aria-label', video.muted ? 'בטל השתקה' : 'השתק');
                volumeSlider.value = video.muted ? 0 : video.volume;
            });

            // Progress Bar
            const progressContainer = document.createElement('div');
            progressContainer.className = 'progress-container';
            const progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';
            progressContainer.appendChild(progressBar);
            progressContainer.addEventListener('click', (e) => {
                const rect = progressContainer.getBoundingClientRect();
                const pos = (e.clientX - rect.left) / rect.width;
                video.currentTime = pos * video.duration;
            });

            video.addEventListener('timeupdate', () => {
                const progress = (video.currentTime / video.duration) * 100;
                progressBar.style.width = `${progress}%`;
            });

            // Fullscreen Button
            const fullscreenBtn = document.createElement('button');
            fullscreenBtn.className = 'media-btn';
            fullscreenBtn.innerHTML = '<i class="fa fa-expand"></i>';
            fullscreenBtn.setAttribute('aria-label', 'מסך מלא');
            fullscreenBtn.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    container.requestFullscreen().then(() => {
                        container.classList.add('fullscreen');
                    });
                } else {
                    document.exitFullscreen().then(() => {
                        container.classList.remove('fullscreen');
                    });
                }
            });

            // Close Button
            const closeBtn = document.createElement('button');
            closeBtn.className = 'media-btn';
            closeBtn.innerHTML = '<i class="fa fa-times"></i>';
            closeBtn.setAttribute('aria-label', 'סגור');
            closeBtn.addEventListener('click', () => {
                container.remove();
                activeChannels = activeChannels.filter(ch => ch !== container.dataset.channel);
                saveActiveChannels();
                document.querySelector(`button[data-channel="${container.dataset.channel}"]`).classList.remove('active');
                updateGridLayout();
            });

            // Keyboard Accessibility
            container.tabIndex = 0;
            container.addEventListener('keydown', (e) => {
                if (e.code === 'Space') {
                    e.preventDefault();
                    playPauseBtn.click();
                } else if (e.code === 'ArrowLeft') {
                    video.currentTime = Math.max(0, video.currentTime - 5);
                } else if (e.code === 'ArrowRight') {
                    video.currentTime = Math.min(video.duration, video.currentTime + 5);
                } else if (e.code === 'ArrowUp') {
                    video.volume = Math.min(1, video.volume + 0.1);
                    volumeSlider.value = video.volume;
                } else if (e.code === 'ArrowDown') {
                    video.volume = Math.max(0, video.volume - 0.1);
                    volumeSlider.value = video.volume;
                }
            });

            // Auto-hide controls in fullscreen
            let hideTimeout;
            function resetHideTimeout() {
                controls.style.opacity = '1';
                clearTimeout(hideTimeout);
                hideTimeout = setTimeout(() => {
                    if (document.fullscreenElement) controls.style.opacity = '0';
                }, 3000);
            }
            container.addEventListener('mousemove', resetHideTimeout);
            container.addEventListener('touchstart', resetHideTimeout);

            controls.append(playPauseBtn, stopBtn, volumeSlider, muteBtn, progressContainer, fullscreenBtn, closeBtn);
            container.appendChild(controls);

            // Sync controls with video events
            video.addEventListener('play', () => {
                playPauseBtn.innerHTML = '<i class="fa fa-pause"></i>';
                playPauseBtn.setAttribute('aria-label', 'השהה');
            });
            video.addEventListener('pause', () => {
                playPauseBtn.innerHTML = '<i class="fa fa-play"></i>';
                playPauseBtn.setAttribute('aria-label', 'הפעל');
            });
            video.addEventListener('volumechange', () => {
                muteBtn.innerHTML = video.muted ? '<i class="fa fa-volume-mute"></i>' : '<i class="fa fa-volume-up"></i>';
                muteBtn.setAttribute('aria-label', video.muted ? 'בטל השתקה' : 'השתק');
                volumeSlider.value = video.muted ? 0 : video.volume;
            });
        }

        /**
         * Shows an overlay for blocked autoplay.
         * @param {HTMLElement} container - The video container.
         * @param {HTMLVideoElement} video - The video element.
         */
        function showAutoplayOverlay(container, video) {
            const overlay = document.createElement('div');
            overlay.className = 'autoplay-overlay';
            const playBtn = document.createElement('button');
            playBtn.className = 'media-btn';
            playBtn.innerHTML = '<i class="fa fa-play" style="font-size: 3rem;"></i>';
            playBtn.setAttribute('aria-label', 'הפעל וידאו');
            playBtn.addEventListener('click', () => {
                video.play().then(() => overlay.remove());
            });
            overlay.appendChild(playBtn);
            container.appendChild(overlay);
        }

        /**
         * Initializes controls for an iframe.
         * @param {HTMLElement} container - The iframe container.
         * @param {HTMLIFrameElement} iframe - The iframe element.
         */
        function initIframeControls(container, iframe) {
            const controls = document.createElement('div');
            controls.className = 'media-controls';

            // Fullscreen Button
            const fullscreenBtn = document.createElement('button');
            fullscreenBtn.className = 'media-btn';
            fullscreenBtn.innerHTML = '<i class="fa fa-expand"></i>';
            fullscreenBtn.setAttribute('aria-label', 'מסך מלא');
            fullscreenBtn.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    container.requestFullscreen().then(() => {
                        container.classList.add('fullscreen');
                    });
                } else {
                    document.exitFullscreen().then(() => {
                        container.classList.remove('fullscreen');
                    });
                }
            });

            // Close Button
            const closeBtn = document.createElement('button');
            closeBtn.className = 'media-btn';
            closeBtn.innerHTML = '<i class="fa fa-times"></i>';
            closeBtn.setAttribute('aria-label', 'סגור');
            closeBtn.addEventListener('click', () => {
                container.remove();
                activeChannels = activeChannels.filter(ch => ch !== container.dataset.channel);
                saveActiveChannels();
                document.querySelector(`button[data-channel="${container.dataset.channel}"]`).classList.remove('active');
                updateGridLayout();
            });

            // Note about iframe limitations
            const note = document.createElement('span');
            note.textContent = 'שליטה מוגבלת עקב מגבלות Cross-Origin';
            note.className = 'text-sm text-gray-300';

            controls.append(fullscreenBtn, closeBtn, note);
            container.appendChild(controls);

            // Auto-hide controls in fullscreen
            let hideTimeout;
            function resetHideTimeout() {
                controls.style.opacity = '1';
                clearTimeout(hideTimeout);
                hideTimeout = setTimeout(() => {
                    if (document.fullscreenElement) controls.style.opacity = '0';
                }, 3000);
            }
            container.addEventListener('mousemove', resetHideTimeout);
            container.addEventListener('touchstart', resetHideTimeout);
        }

        /**
         * Updates the video grid layout based on active channels.
         */
        function updateGridLayout() {
            const activeCount = activeChannels.length;
            videoGrid.className = `grid-container grid-${activeCount || 1}`;
            videoGrid.innerHTML = '';
            activeChannels.forEach(channelKey => {
                const player = createVideoPlayer(channelKey);
                videoGrid.appendChild(player);
                const button = document.querySelector(`button[data-channel="${channelKey}"]`);
                if (button) button.classList.add('active');
            });
        }

        // Initialize channel buttons
        buttons.forEach(button => {
            button.addEventListener('click', () => {
                const channelKey = button.dataset.channel;
                if (activeChannels.includes(channelKey)) {
                    activeChannels = activeChannels.filter(ch => ch !== channelKey);
                    button.classList.remove('active');
                } else {
                    activeChannels = [channelKey, ...activeChannels];
                    button.classList.add('active');
                }
                saveActiveChannels();
                updateGridLayout();
            });
            // Set initial active state for saved channels
            if (activeChannels.includes(button.dataset.channel)) {
                button.classList.add('active');
            }
        });

        // Load saved channels on page load
        if (activeChannels.length) {
            updateGridLayout();
        }
    </script>
    <div class="contailink">
        <p>
            <a href="https://mistralnet.github.io/radio/radio.html" rel="noopener noreferrer" class="inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-lg text-base font-medium bg-white text-gray-900 border border-gray-300 hover:bg-blue-100 hover:text-blue-800 focus:outline-none focus:ring-4 focus:ring-blue-400 disabled:pointer-events-none disabled:opacity-50 h-12 px-6 py-3 shadow-sm hover:shadow-md transition-all duration-200" aria-label="פתח תחנות רדיו להאזנה">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-6 w-6" aria-hidden="true"><path d="M4.9 19.1C1 15.2 1 8.8 4.9 4.9"></path><path d="M7.8 16.2c-2.3-2.3-2.3-6.1 0-8.5"></path><circle cx="12" cy="12" r="2"></circle><path d="M16.2 7.8c2.3 2.3 2.3 6.1 0 8.5"></path><path d="M19.1 4.9C23 8.8 23 15.2 19.1 19.1"></path></svg>תחנות רדיו להאזנה
            </a>
        </p>
    </div>
    <div class="contaibox">
        גרסה 3 - מתוקנת
    </div>
</body>
</html>
