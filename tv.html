<!DOCTYPE html>
<html lang="he">
<head>
    <!-- Google Tag Manager -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J5WT91REYB"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-J5WT91REYB');
    </script>
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-P5QLH7TD');</script>
    <!-- End Google Tag Manager -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no">
    <title>צפייה בערוצי שידור</title>
    <link rel="icon" href="icon.png" type="image/png">
    <link rel="apple-touch-icon" href="icon.png">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <link rel="stylesheet" href="dist/tailwind.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --main-bg-color: #1F2937;
            --main-text-color: #fff;
            --secondary-text-color: #989494;
            --highlight-color: #1F6FEB;
        }

        body {
            font-family: Arial, sans-serif;
            direction: rtl;
            margin: 0;
            padding: 0;
            background-color: var(--main-bg-color);
            color: var(--main-text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .container {
            flex: 1;
            padding: 16px;
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .video-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16 / 9;
            max-height: 100%;
        }

        .media-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            padding: 8px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 10;
        }

        .video-container:hover .media-controls, .video-container:focus-within .media-controls {
            opacity: 1;
        }

        .media-btn {
            background: none;
            border: none;
            color: var(--main-text-color);
            cursor: pointer;
            font-size: 1.1rem;
            padding: 4px;
        }

        .progress-container {
            flex-grow: 1;
            height: 4px;
            background: #444;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: var(--highlight-color);
            border-radius: 4px;
            width: 0;
        }

        .volume-slider {
            width: 60px;
            accent-color: var(--highlight-color);
        }

        .grid-container {
            display: grid;
            gap: 8px;
            width: 100%;
            max-width: 100%;
            height: calc(100vh - 160px);
            overflow-x: hidden;
        }

        .channel-button {
            padding: 8px 16px;
            background-color: #4B5563;
            color: var(--main-text-color);
            border-radius: 4px;
            border: 2px solid transparent;
            transition: border-color 0.3s, background-color 0.3s;
        }

        .channel-button.active {
            background-color: var(--highlight-color);
            border-color: var(--main-text-color);
        }

        .channel-button:hover {
            background-color: #6B7280;
        }

        .autoplay-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
        }

        .footer {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            padding: 16px;
            background-color: #111827;
            text-align: center;
            flex-wrap: wrap;
        }

        .footer a {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background-color: var(--main-text-color);
            color: #111827;
            border-radius: 4px;
            text-decoration: none;
            transition: background-color 0.3s;
        }

        .footer a:hover {
            background-color: #E5E7EB;
        }

        @media (min-width: 768px) {
            .grid-1 { grid-template-columns: 1fr; }
            .grid-2 { grid-template-columns: 1fr; grid-template-rows: repeat(2, 1fr); }
            .grid-3 { grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); }
            .grid-4 { grid-template-columns: repeat(2, 1fr); grid-template-rows: repeat(2, 1fr); }
            .grid-5 { grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(2, 1fr); }
            .grid-5 .video-container:first-child { grid-column: span 2; }
            .video-container { max-height: calc((100vh - 160px - 24px) / 2); }
            .channel-button { width: 120px; }
        }

        @media (max-width: 767px) {
            .grid-1, .grid-2, .grid-3, .grid-4, .grid-5 {
                grid-template-columns: 1fr;
                height: auto;
                overflow-y: auto;
            }
            .video-container { max-height: none; }
            .channel-button { width: 90px; }
        }

        .fullscreen .media-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
        }
    </style>
</head>
<body>
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-P5QLH7TD" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <div class="container">
        <h1 class="text-2xl font-bold mb-4">צפייה בערוצי שידור</h1>
        <p class="mb-2 text-sm text-[var(--secondary-text-color)]">22בחר ערוצים פעילים להצגה:</p>
        <div class="flex justify-center gap-4 mb-4 flex-wrap">
            <button class="channel-button" data-channel="kan11" aria-label="בחר כאן 11">כאן 11</button>
            <button class="channel-button" data-channel="now14" aria-label="בחר עכשיו 14">עכשיו 14</button>
            <button class="channel-button" data-channel="i24news" aria-label="בחר i24NEWS">i24NEWS</button>
            <button class="channel-button" data-channel="news12" aria-label="בחר חדשות 12">חדשות 12</button>
            <button class="channel-button" data-channel="news13" aria-label="בחר חדשות 13">חדשות 13</button>
        </div>
        <div id="video-grid" class="grid-container"></div>
    </div>

    <footer class="footer">
        <a href="https://mistralnet.github.io/radio/radio.html" rel="noopener noreferrer" aria-label="פתח תחנות רדיו להאזנה">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                <path d="M4.9 19.1C1 15.2 1 8.8 4.9 4.9"></path>
                <path d="M7.8 16.2c-2.3-2.3-2.3-6.1 0-8.5"></path>
                <circle cx="12" cy="12" r="2"></circle>
                <path d="M16.2 7.8c2.3 2.3 2.3 6.1 0 8.5"></path>
                <path d="M19.1 4.9C23 8.8 23 15.2 19.1 19.1"></path>
            </svg>
            תחנות רדיו להאזנה
        </a>
        <span class="text-sm text-[var(--secondary-text-color)]">גרסה 3 - מתוקנת</span>
    </footer>

    <script>
        const channels = {
            kan11: { type: 'hls', url: 'https://kan11w.media.kan.org.il/hls/live/2105694/2105694/source1_4k/chunklist.m3u8', name: 'כאן 11' },
            now14: { type: 'iframe', url: 'https://www.now14.co.il/live/?autoplay=1&mute=1&autoPlay=true&muted=true', name: 'עכשיו 14' },
            i24news: { type: 'hls', url: 'https://bcovlive-a.akamaihd.net/d89ede8094c741b7924120b27764153c/eu-central-1/5377161796001/profile_0/chunklist.m3u8', name: 'i24NEWS' },
            news12: { type: 'iframe', url: 'https://www.mako.co.il/mako-vod-live-tv/VOD-6540b8dcb64fd31006.htm?autoplay=1&muted=true&autoPlay=true', name: 'חדשות 12' },
            news13: { type: 'hls', url: 'https://d198ztbnlup2iq.cloudfront.net/out/v1/2d9050c90fb94df8b78d1d98306a1a65/index.m3u8', name: 'חדשות 13' }
        };

        const videoGrid = document.getElementById('video-grid');
        const buttons = document.querySelectorAll('.channel-button');
        let activeChannels = JSON.parse(localStorage.getItem('activeChannels') || '[]');
        let wakeLock = null;
        let wakeLockInterval = null;

        function saveActiveChannels() {
            localStorage.setItem('activeChannels', JSON.stringify(activeChannels));
        }

        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator && !wakeLock) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => {
                        if (wakeLock) requestWakeLock();
                    });
                }
            } catch (err) {
                console.log(`Wake Lock Error: ${err.name}, ${err.message}`);
            }
        }

        function startKeepAwake() {
            if (!wakeLockInterval) {
                wakeLockInterval = setInterval(() => {
                    if (wakeLock) requestWakeLock();
                }, 15000);
            }
        }

        function stopKeepAwake() {
            if (wakeLockInterval) {
                clearInterval(wakeLockInterval);
                wakeLockInterval = null;
            }
        }

        function createVideoPlayer(channelKey) {
            const channel = channels[channelKey];
            const container = document.createElement('div');
            container.className = 'video-container';
            container.dataset.channel = channelKey;

            if (channel.type === 'hls') {
                const video = document.createElement('video');
                video.className = 'w-full h-full';
                video.muted = true;
                container.appendChild(video);

                if (Hls.isSupported()) {
                    const hls = new Hls();
                    hls.loadSource(channel.url);
                    hls.attachMedia(video);
                    hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(() => showAutoplayOverlay(container, video)));
                    hls.on(Hls.Events.ERROR, () => showAutoplayOverlay(container, video));
                } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                    video.src = channel.url;
                    video.addEventListener('loadedmetadata', () => video.play().catch(() => showAutoplayOverlay(container, video)));
                }

                video.addEventListener('click', () => video.paused ? video.play() : video.pause());
                video.addEventListener('play', () => container.querySelector('.autoplay-overlay')?.remove());
                initMediaControls(container, video);
            } else {
                const iframe = document.createElement('iframe');
                iframe.className = 'w-full h-full';
                iframe.src = channel.url;
                iframe.allow = 'autoplay; fullscreen';
                iframe.setAttribute('allowfullscreen', '');
                container.appendChild(iframe);
                initIframeControls(container, iframe);
            }

            return container;
        }

        function initMediaControls(container, video) {
            const controls = document.createElement('div');
            controls.className = 'media-controls';

            const playPauseBtn = document.createElement('button');
            playPauseBtn.className = 'media-btn';
            playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
            playPauseBtn.setAttribute('aria-label', 'השהה');
            playPauseBtn.addEventListener('click', () => {
                if (video.paused) {
                    video.play().catch(() => showAutoplayOverlay(container, video));
                    playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                    playPauseBtn.setAttribute('aria-label', 'השהה');
                } else {
                    video.pause();
                    playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                    playPauseBtn.setAttribute('aria-label', 'הפעל');
                }
            });

            const stopBtn = document.createElement('button');
            stopBtn.className = 'media-btn';
            stopBtn.innerHTML = '<i class="fas fa-stop"></i>';
            stopBtn.setAttribute('aria-label', 'עצור');
            stopBtn.addEventListener('click', () => {
                video.pause();
                video.currentTime = 0;
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                playPauseBtn.setAttribute('aria-label', 'הפעל');
            });

            const volumeSlider = document.createElement('input');
            volumeSlider.type = 'range';
            volumeSlider.className = 'volume-slider';
            volumeSlider.min = '0';
            volumeSlider.max = '1';
            volumeSlider.step = '0.1';
            volumeSlider.value = video.volume;
            volumeSlider.setAttribute('aria-label', 'שליטה בעוצמת הקול');

            const muteBtn = document.createElement('button');
            muteBtn.className = 'media-btn';
            muteBtn.innerHTML = '<i class="fas fa-volume-up"></i>';
            muteBtn.setAttribute('aria-label', 'השתק');
            muteBtn.addEventListener('click', () => {
                video.muted = !video.muted;
                muteBtn.innerHTML = video.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
                muteBtn.setAttribute('aria-label', video.muted ? 'בטל השתקה' : 'השתק');
                volumeSlider.value = video.muted ? 0 : video.volume;
            });

            volumeSlider.addEventListener('input', () => {
                video.volume = volumeSlider.value;
                video.muted = volumeSlider.value == 0;
                muteBtn.innerHTML = video.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
                muteBtn.setAttribute('aria-label', video.muted ? 'בטל השתקה' : 'השתק');
            });

            const progressContainer = document.createElement('div');
            progressContainer.className = 'progress-container';
            const progressBar = document.createElement('div');
            progressBar.className = 'progress-bar';
            progressContainer.appendChild(progressBar);
            progressContainer.addEventListener('click', (e) => {
                const rect = progressContainer.getBoundingClientRect();
                const pos = (e.clientX - rect.left) / rect.width;
                video.currentTime = pos * video.duration;
            });

            video.addEventListener('timeupdate', () => {
                const progress = (video.currentTime / video.duration) * 100;
                progressBar.style.width = `${progress}%`;
            });

            const fullscreenBtn = document.createElement('button');
            fullscreenBtn.className = 'media-btn';
            fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            fullscreenBtn.setAttribute('aria-label', 'מסך מלא');
            fullscreenBtn.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    container.requestFullscreen().then(() => container.classList.add('fullscreen'));
                } else {
                    document.exitFullscreen().then(() => container.classList.remove('fullscreen'));
                }
            });

            const closeBtn = document.createElement('button');
            closeBtn.className = 'media-btn';
            closeBtn.innerHTML = '<i class="fas fa-times"></i>';
            closeBtn.setAttribute('aria-label', 'סגור');
            closeBtn.addEventListener('click', () => {
                container.remove();
                activeChannels = activeChannels.filter(ch => ch !== container.dataset.channel);
                saveActiveChannels();
                document.querySelector(`button[data-channel="${container.dataset.channel}"]`)?.classList.remove('active');
                updateGridLayout();
            });

            container.tabIndex = 0;
            container.addEventListener('keydown', (e) => {
                if (e.key === 'Space') {
                    e.preventDefault();
                    playPauseBtn.click();
                } else if (e.key === 'ArrowLeft') {
                    video.currentTime = Math.max(0, video.currentTime - 5);
                } else if (e.key === 'ArrowRight') {
                    video.currentTime = Math.min(video.duration, video.currentTime + 5);
                } else if (e.key === 'ArrowUp') {
                    video.volume = Math.min(1, video.volume + 0.1);
                    volumeSlider.value = video.volume;
                } else if (e.key === 'ArrowDown') {
                    video.volume = Math.max(0, video.volume - 0.1);
                    volumeSlider.value = video.volume;
                }
            });

            let hideTimeout;
            function resetHideTimeout() {
                controls.style.opacity = '1';
                clearTimeout(hideTimeout);
                hideTimeout = setTimeout(() => {
                    if (document.fullscreenElement) controls.style.opacity = '0';
                }, 3000);
            }
            container.addEventListener('mousemove', resetHideTimeout);
            container.addEventListener('touchstart', resetHideTimeout);

            controls.append(playPauseBtn, stopBtn, volumeSlider, muteBtn, progressContainer, fullscreenBtn, closeBtn);
            container.appendChild(controls);

            video.addEventListener('play', () => {
                playPauseBtn.innerHTML = '<i class="fas fa-pause"></i>';
                playPauseBtn.setAttribute('aria-label', 'השהה');
            });
            video.addEventListener('pause', () => {
                playPauseBtn.innerHTML = '<i class="fas fa-play"></i>';
                playPauseBtn.setAttribute('aria-label', 'הפעל');
            });
            video.addEventListener('volumechange', () => {
                muteBtn.innerHTML = video.muted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>';
                muteBtn.setAttribute('aria-label', video.muted ? 'בטל השתקה' : 'השתק');
                volumeSlider.value = video.muted ? 0 : video.volume;
            });
        }

        function showAutoplayOverlay(container, video) {
            const overlay = document.createElement('div');
            overlay.className = 'autoplay-overlay';
            const playBtn = document.createElement('button');
            playBtn.className = 'media-btn';
            playBtn.innerHTML = '<i class="fas fa-play" style="font-size: 2rem;"></i>';
            playBtn.setAttribute('aria-label', 'הפעל וידאו');
            playBtn.addEventListener('click', () => {
                video.play().then(() => overlay.remove());
            });
            overlay.appendChild(playBtn);
            container.appendChild(overlay);
        }

        function initIframeControls(container, iframe) {
            const controls = document.createElement('div');
            controls.className = 'media-controls';

            const fullscreenBtn = document.createElement('button');
            fullscreenBtn.className = 'media-btn';
            fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
            fullscreenBtn.setAttribute('aria-label', 'מסך מלא');
            fullscreenBtn.addEventListener('click', () => {
                if (!document.fullscreenElement) {
                    container.requestFullscreen().then(() => container.classList.add('fullscreen'));
                } else {
                    document.exitFullscreen().then(() => container.classList.remove('fullscreen'));
                }
            });

            const closeBtn = document.createElement('button');
            closeBtn.className = 'media-btn';
            closeBtn.innerHTML = '<i class="fas fa-times"></i>';
            closeBtn.setAttribute('aria-label', 'סגור');
            closeBtn.addEventListener('click', () => {
                container.remove();
                activeChannels = activeChannels.filter(ch => ch !== container.dataset.channel);
                saveActiveChannels();
                document.querySelector(`button[data-channel="${container.dataset.channel}"]`)?.classList.remove('active');
                updateGridLayout();
            });

            const note = document.createElement('span');
            note.textContent = 'שליטה מוגבלת עקב מגבלות Cross-Origin';
            note.className = 'text-xs text-[var(--secondary-text-color)]';

            controls.append(fullscreenBtn, closeBtn, note);
            container.appendChild(controls);

            let hideTimeout;
            function resetHideTimeout() {
                controls.style.opacity = '1';
                clearTimeout(hideTimeout);
                hideTimeout = setTimeout(() => {
                    if (document.fullscreenElement) controls.style.opacity = '0';
                }, 3000);
            }
            container.addEventListener('mousemove', resetHideTimeout);
            container.addEventListener('touchstart', resetHideTimeout);
        }

        function updateGridLayout() {
            const activeCount = activeChannels.length;
            videoGrid.className = `grid-container grid-${activeCount || 1}`;
            videoGrid.innerHTML = '';
            activeChannels.forEach(channelKey => {
                const player = createVideoPlayer(channelKey);
                videoGrid.appendChild(player);
                document.querySelector(`button[data-channel="${channelKey}"]`)?.classList.add('active');
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    const channelKey = button.dataset.channel;
                    if (activeChannels.includes(channelKey)) {
                        activeChannels = activeChannels.filter(ch => ch !== channelKey);
                        button.classList.remove('active');
                    } else {
                        activeChannels = [channelKey, ...activeChannels];
                        button.classList.add('active');
                    }
                    saveActiveChannels();
                    updateGridLayout();
                });
                if (activeChannels.includes(button.dataset.channel)) {
                    button.classList.add('active');
                }
            });

            if (activeChannels.length) {
                updateGridLayout();
            }

            requestWakeLock();
            startKeepAwake();

            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'visible' && !wakeLock) {
                    window.location.reload(true);
                }
            });
        });
    </script>
</body>
</html>
