<!DOCTYPE html>
<html lang="he">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>רדיו כאן ועכשיו</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f0f0f0;
            margin: 0;
            padding: 0;
        }

        #app {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        button {
            padding: 10px 15px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }

        button:hover {
            background-color: #0056b3;
        }

        #volume-controls {
            margin-top: 10px;
        }

        #volume-slider {
            width: 100px;
        }

        #cast-status {
            margin-top: 10px;
            font-style: italic;
            color: #777;
        }
    </style>
</head>

<body>
    <div id="app">
        <h1>רדיו כאן ועכשיו</h1>
        <audio id="audioPlayer" src="" controls preload="none"></audio>
        <div id="volume-controls">
            <label for="volume-slider">עוצמת שמע:</label>
            <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="1">
        </div>
        <button id="playButton">הפעל</button>
        <button id="pauseButton">עצור</button>
        <button id="castButton">העבר ל-Chromecast</button>
        <p id="cast-status"></p>
        <button id="kanButton">כאן ב</button>
        <button id="glzButton">גל"צ</button>
        <button id="disconnectButton" style="display:none;">נתק Chromecast</button>
        <p>גרסה: 6.0</p>
        <p>נוצר בתאריך: 6/6/2024 שעה: 18:30</p>
    </div>

    <script>
        const audioPlayer = document.getElementById('audioPlayer');
        const playButton = document.getElementById('playButton');
        const pauseButton = document.getElementById('pauseButton');
        const volumeSlider = document.getElementById('volume-slider');
        const castButton = document.getElementById('castButton');
        const castStatus = document.getElementById('cast-status');
        const kanButton = document.getElementById('kanButton');
        const glzButton = document.getElementById('glzButton');
        const disconnectButton = document.getElementById('disconnectButton');

        let currentStation = "";
        const KAN_STATION = "https://28503.live.streamtheworld.com/KAN_BET.mp3?dist=radio2net";
        const GLZ_STATION = "https://glzwizzlv.bynetcdn.com/glz_mp3?awCollectionId=misc&awEpisodeId=glz";

        playButton.addEventListener('click', () => {
            audioPlayer.play();
        });

        pauseButton.addEventListener('click', () => {
            audioPlayer.pause();
        });

        volumeSlider.addEventListener('input', () => {
            audioPlayer.volume = volumeSlider.value;
        });

        kanButton.addEventListener('click', () => {
            loadStation(KAN_STATION);
        });

        glzButton.addEventListener('click', () => {
            loadStation(GLZ_STATION);
        });

        castButton.addEventListener('click', castMedia);
        disconnectButton.addEventListener('click', disconnectSession);

        function loadStation(stationURL) {
            currentStation = stationURL;
            audioPlayer.src = stationURL;
            audioPlayer.load();
            audioPlayer.play();
            castStatus.textContent = "טוען תחנה...";

            if (session) {
                loadMediaOnCast();
            }

        }

        function castMedia() {
            castStatus.textContent = "מחפש Chromecast...";

            // Check if Cast is available
            if (typeof chrome.cast === 'undefined' || !chrome.cast || !chrome.cast.isAvailable) {
                castStatus.textContent = "Chromecast לא זמין, מנסה לאתחל שוב...";
                setTimeout(() => {
                    initializeCastApi(); // Try to initialize again after a delay
                }, 1000);
                return;
            }

            launchApp();
        }

        let session = null;

        function initializeCastApi() {
            castStatus.textContent = "מאתחל API...";

            // Check if chrome.cast and chrome.cast.SessionRequest are defined
            if (typeof chrome.cast === 'undefined' || typeof chrome.cast.SessionRequest === 'undefined') {
                castStatus.textContent = "שגיאה: chrome.cast או chrome.cast.SessionRequest לא מוגדרים.";
                return;
            }

            const sessionRequest = new chrome.cast.SessionRequest(chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID);
            const apiConfig = new chrome.cast.ApiConfig(sessionRequest,
                sessionListener,
                receiverListener);

            chrome.cast.initialize(apiConfig, onInitSuccess, onError);
        }

        function onInitSuccess() {
            castStatus.textContent = "אתחול הצליח!";
            checkExistingSession(); // Check for existing session on init
        }

        function onError(message) {
            castStatus.textContent = "שגיאה: " + message;
        }

        function sessionListener(newSession) {
            castStatus.textContent = 'מחובר ל-Chromecast!';
            session = newSession;
            disconnectButton.style.display = 'inline'; // Show disconnect button
            // Stop local playback when casting starts
            audioPlayer.pause();
            loadMediaOnCast();
        }

        function receiverListener(receiver) {
            castStatus.textContent = 'התקבל רסיבר: ' + receiver.friendlyName;
        }

        function launchApp() {
            chrome.cast.requestSession(
                function (newSession) {
                    session = newSession;
                    castStatus.textContent = 'אפליקציה הושקה.';
                    disconnectButton.style.display = 'inline'; // Show disconnect button
                    // Stop local playback when casting starts
                    audioPlayer.pause();
                    loadMediaOnCast();
                },
                function (err) {
                    castStatus.textContent = 'שגיאת השקה: ' + err.message;
                }
            );
        }

        function loadMediaOnCast() {
            if (!session) {
                castStatus.textContent = 'אין סשן פעיל.';
                return;
            }

            castStatus.textContent = 'טוען מדיה ב-Chromecast...';
            const mediaInfo = new chrome.cast.media.MediaInfo(
                currentStation,
                'audio/mp3');
            mediaInfo.streamType = chrome.cast.media.StreamType.LIVE;

            const request = new chrome.cast.media.LoadRequest(mediaInfo);
            session.loadMedia(request,
                function () {
                    castStatus.textContent = 'מדיה נטענה בהצלחה ב-Chromecast!';
                },
                function (err) {
                    castStatus.textContent = 'שגיאת טעינה: ' + err.message;
                });
        }
        function checkExistingSession() {
            castStatus.textContent = "בודק סשן קיים...";
            try {
                const castContext = chrome.cast.framework.CastContext.getInstance();
                if (castContext && castContext.getCurrentSession()) {
                    castStatus.textContent = "נמצא שידור קודם. אנא נתק את השידור הקודם לפני חיבור מחדש.";
                    disconnectButton.style.display = 'inline'; // Show disconnect button
                } else {
                    disconnectButton.style.display = 'none'; // Hide disconnect button
                }
            } catch (e) {
                castStatus.textContent = "שגיאה בבדיקת סשן קיים: " + e.message;
            }
        }


        function disconnectSession() {
            castStatus.textContent = "מנתק מה-Chromecast...";
            session.leave(function () {
                session = null;
                castStatus.textContent = "השידור נותק.";
                disconnectButton.style.display = 'none'; // Hide disconnect button
            }, function (err) {
                castStatus.textContent = "שגיאה בניסיון ניתוק: " + err.message;
            });
        }

        // Initialize Cast API after the page has loaded
        window.onload = function () {
            castStatus.textContent = "טוען Chromecast API...";
            if (typeof chrome.cast !== 'undefined' && chrome.cast && chrome.cast.isAvailable) {
                cast.framework.CastContext.getInstance().setOptions({
                    receiverApplicationId: chrome.cast.media.DEFAULT_MEDIA_RECEIVER_APP_ID,
                    autoJoinPolicy: chrome.cast.AutoJoinPolicy.ORIGIN_SCOPED
                });
                initializeCastApi();
            } else {
                castStatus.textContent = "Chromecast לא זמין, נסה שוב מאוחר יותר. ממתין לזמינות...";
                setTimeout(function () {
                    initializeCastApi();
                }, 3000);
            }
        };
    </script>
    <script type="text/javascript" src="https://www.gstatic.com/cv/js/sender/v1/cast_sender.js?loadCastFramework=1"></script>
</body>

</html>
